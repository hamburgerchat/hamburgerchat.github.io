<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hamburger ‚Äî –ß–∞—Ç</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f1f3f4;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-color: #e5e7eb;
            --accent-color: #ff7f50;
            --accent-gradient: linear-gradient(135deg, #ff7f50, #ffcc70);
            --chat-bg: #f0f2f5;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-light: 0 1px 2px rgba(0,0,0,0.05);
            --card-bg: #ffffff;
            --hover-bg: #f3f4f6;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --message-bg: #ffffff;
            --own-message-bg: #e3f2fd;
            --channel-message-bg: #f0f9ff;
            --role-creator: #ff6b35;
            --role-admin: #4ecdc4;
            --role-member: #94a3b8;
            --online-color: #10b981;
            --typing-color: #f59e0b;
            --reply-bg: #f8f9fa;
            --service-bg: rgba(255, 127, 80, 0.1);
            --service-text: #ff7f50;
            --read-color: #2563eb;
            --notification-bg: rgba(0, 0, 0, 0.7);
            --notification-text: #ffffff;
            --link-color: #2563eb;
            --call-color: #10b981;
            --channel-color: #8b5cf6;
            --bot-color: #10b981;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border-color: #334155;
            --card-bg: #1e293b;
            --hover-bg: #334155;
            --chat-bg: #0f172a;
            --shadow: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-light: 0 1px 2px rgba(0,0,0,0.2);
            --message-bg: #1e293b;
            --own-message-bg: #1e3a5f;
            --channel-message-bg: #1e1b4b;
            --role-creator: #fdba74;
            --role-admin: #5eead4;
            --role-member: #64748b;
            --reply-bg: #334155;
            --service-bg: rgba(253, 186, 116, 0.15);
            --service-text: #fdba74;
            --read-color: #60a5fa;
            --notification-bg: rgba(255, 255, 255, 0.9);
            --notification-text: #1e293b;
            --link-color: #60a5fa;
            --call-color: #34d399;
            --channel-color: #a78bfa;
            --bot-color: #34d399;
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: 'Inter', sans-serif; 
        }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--chat-bg);
            position: relative;
        }
        
        .chat-header {
            background: var(--bg-primary);
            padding: 0.7rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
            min-height: 60px;
            backdrop-filter: blur(10px);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            flex: 1;
        }
        
        .back-button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .back-button:hover {
            background: var(--hover-bg);
            transform: translateX(-2px);
        }
        
        .chat-info {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            cursor: pointer;
            flex: 1;
            min-width: 0;
        }
        
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            font-size: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        
        .chat-avatar.has-image {
            background-size: cover;
            background-position: center;
        }
        
        .chat-avatar.channel {
            background: linear-gradient(135deg, var(--channel-color), #c4b5fd);
        }
        
        .chat-avatar.bot {
            background: linear-gradient(135deg, var(--bot-color), #34d399);
        }
        
        .chat-details {
            display: flex;
            flex-direction: column;
            min-width: 0;
            flex: 1;
        }
        
        .chat-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-status {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .online-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--online-color);
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .call-button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--call-color);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .call-button:hover {
            background: var(--hover-bg);
            transform: scale(1.1);
        }
        
        .call-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .menu-toggle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .menu-toggle:hover {
            background: var(--hover-bg);
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0.8rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            scroll-behavior: smooth;
            padding-bottom: 100px;
        }
        
        .message {
            display: flex;
            max-width: 75%;
            position: relative;
            animation: messageAppear 0.3s ease;
        }
        
        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.own {
            align-self: flex-end;
            margin-left: auto;
        }
        
        .message.channel {
            max-width: 85%;
        }
        
        .message.bot {
            max-width: 85%;
        }
        
        .message.group:not(.own) {
            padding-left: 36px;
        }
        
        .message-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            font-size: 0.7rem;
            position: absolute;
            left: 0;
            bottom: 2px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            background-size: cover;
            background-position: center;
        }
        
        .message-content {
            background: var(--message-bg);
            border-radius: 16px;
            padding: 0.6rem 0.9rem;
            box-shadow: var(--shadow-light);
            position: relative;
            min-width: 50px;
            border: 1px solid rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .message-content:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .message.own .message-content {
            background: var(--own-message-bg);
            border-bottom-right-radius: 6px;
        }
        
        .message.channel .message-content {
            background: var(--message-bg);
            border-left: 3px solid var(--channel-color);
        }
        
        .message.bot .message-content {
            background: var(--message-bg);
            border-left: 3px solid var(--bot-color);
        }
        
        .message:not(.own) .message-content {
            border-bottom-left-radius: 6px;
        }
        
        .message-header {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 0.2rem;
        }
        
        .sender-name {
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--text-primary);
            cursor: pointer;
        }
        
        .message-role {
            font-size: 0.6rem;
            font-weight: 600;
            padding: 0.1rem 0.3rem;
            border-radius: 6px;
            background: var(--role-member);
            color: white;
        }
        
        .role-creator {
            background: var(--role-creator);
        }
        
        .role-admin {
            background: var(--role-admin);
        }
        
        .message-text {
            font-size: 0.85rem;
            line-height: 1.4;
            color: var(--text-primary);
            word-wrap: break-word;
        }
        
        .message-text a {
            color: var(--link-color);
            text-decoration: underline;
        }
        
        .message-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 0.3rem;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .message-sticker {
            font-size: 2rem;
            text-align: center;
            padding: 0.4rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .message-sticker:hover {
            transform: scale(1.1);
        }
        
        .message-time {
            font-size: 0.65rem;
            color: var(--text-tertiary);
            text-align: right;
            margin-top: 0.2rem;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.2rem;
        }
        
        .message.own .message-time {
            text-align: left;
            justify-content: flex-start;
        }
        
        .message-status {
            display: flex;
            gap: 0.1rem;
        }
        
        .status-icon {
            font-size: 0.55rem;
            color: var(--text-tertiary);
        }
        
        .status-icon.read {
            color: var(--read-color);
        }
        
        .reactions {
            display: flex;
            gap: 0.2rem;
            margin-top: 0.2rem;
            flex-wrap: wrap;
        }
        
        .reaction {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 0.1rem 0.3rem;
            font-size: 0.65rem;
            display: flex;
            align-items: center;
            gap: 0.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .reaction:hover {
            transform: scale(1.05);
            background: var(--hover-bg);
        }
        
        .reaction.user-reaction {
            background: rgba(255, 127, 80, 0.1);
            border-color: var(--accent-color);
        }
        
        .reaction-count {
            font-size: 0.55rem;
            color: var(--text-secondary);
        }
        
        .reaction-users {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.4rem;
            font-size: 0.65rem;
            white-space: nowrap;
            z-index: 10;
            box-shadow: var(--shadow);
            display: none;
        }
        
        .reaction:hover .reaction-users {
            display: block;
        }
        
        .reply-preview {
            background: var(--reply-bg);
            border-left: 3px solid var(--accent-color);
            padding: 0.3rem 0.5rem;
            border-radius: 5px;
            margin-bottom: 0.3rem;
            font-size: 0.75rem;
            cursor: pointer;
        }
        
        .reply-sender {
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 0.1rem;
            font-size: 0.7rem;
        }
        
        .reply-text {
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.7rem;
        }
        
        .reply-container {
            background: var(--bg-primary);
            padding: 0.5rem 0.9rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .reply-info {
            flex: 1;
        }
        
        .reply-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.1rem;
        }
        
        .reply-content {
            font-size: 0.85rem;
            color: var(--text-primary);
        }
        
        .cancel-reply {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 0.2rem;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .cancel-reply:hover {
            background: var(--hover-bg);
        }
        
        .input-container {
            background: var(--bg-primary);
            padding: 0.7rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 90;
            backdrop-filter: blur(10px);
        }
        
        .channel-input-container {
            display: none;
            background: var(--bg-primary);
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            flex-direction: column;
            gap: 0.8rem;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 90;
            backdrop-filter: blur(10px);
        }
        
        .channel-actions {
            display: flex;
            gap: 0.8rem;
            justify-content: center;
        }
        
        .channel-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.4rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.8rem;
            border-radius: 0.8rem;
            transition: all 0.2s ease;
            min-width: 80px;
        }
        
        .channel-action-btn:hover {
            background: var(--hover-bg);
            color: var(--accent-color);
        }
        
        .channel-action-icon {
            font-size: 1.2rem;
        }
        
        .channel-action-text {
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .subscribe-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        
        .subscribe-btn:hover {
            background: #ff6b35;
            transform: translateY(-1px);
        }
        
        .subscribe-btn.unsubscribe {
            background: var(--danger-color);
        }
        
        .subscribe-btn.unsubscribe:hover {
            background: #dc2626;
        }
        
        .attachment-btn, .sticker-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .attachment-btn:hover, .sticker-btn:hover {
            background: var(--hover-bg);
            color: var(--accent-color);
        }
        
        .message-input-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .message-input {
            width: 100%;
            min-height: 36px;
            max-height: 100px;
            padding: 0.5rem 0.7rem;
            border: 1px solid var(--border-color);
            border-radius: 18px;
            font-size: 0.85rem;
            resize: none;
            outline: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border 0.2s ease;
            line-height: 1.4;
        }
        
        .message-input:focus {
            border-color: var(--accent-color);
        }
        
        .send-button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--accent-color);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(255, 127, 80, 0.3);
        }
        
        .send-button:hover:not(:disabled) {
            background: #ff6b35;
            transform: scale(1.05);
        }
        
        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .service-message {
            text-align: center;
            margin: 0.6rem 0;
            padding: 0.3rem 0.9rem;
            align-self: center;
            max-width: 80%;
        }
        
        .service-content {
            background: var(--service-bg);
            color: var(--service-text);
            padding: 0.3rem 1rem;
            border-radius: 14px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-block;
            border: 1px solid var(--service-bg);
        }
        
        .call-message {
            background: var(--service-bg);
            border: 1px solid var(--call-color);
            border-radius: 16px;
            padding: 0.9rem;
            text-align: center;
            max-width: 280px;
            margin: 0.4rem auto;
        }
        
        .call-message-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.6rem;
        }
        
        .call-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--call-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.3rem;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .call-title {
            font-weight: 600;
            color: var(--call-color);
            font-size: 0.9rem;
        }
        
        .call-description {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        
        .call-buttons {
            display: flex;
            gap: 0.6rem;
            margin-top: 0.4rem;
        }
        
        .call-accept-btn {
            padding: 0.5rem 1rem;
            background: var(--call-color);
            color: white;
            border: none;
            border-radius: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.8rem;
        }
        
        .call-accept-btn:hover {
            background: #0da271;
            transform: translateY(-2px);
        }
        
        .call-decline-btn {
            padding: 0.5rem 1rem;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.8rem;
        }
        
        .call-decline-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }
        
        .chat-menu {
            display: none;
            position: fixed;
            top: 60px;
            right: 1rem;
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: var(--shadow);
            z-index: 1000;
            animation: fadeIn 0.2s ease;
            min-width: 180px;
            border: 1px solid var(--border-color);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .menu-item {
            padding: 0.9rem 1rem;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.7rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .menu-item:last-child {
            border-bottom: none;
        }
        
        .menu-item:hover {
            background: var(--hover-bg);
        }
        
        .menu-icon {
            width: 14px;
            text-align: center;
            color: var(--text-secondary);
        }
        
        .menu-text {
            font-size: 0.85rem;
            color: var(--text-primary);
        }
        
        .menu-danger {
            color: var(--danger-color);
        }
        
        .menu-danger .menu-icon {
            color: var(--danger-color);
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 999;
        }
        
        .message-context-menu {
            display: none;
            position: fixed;
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: var(--shadow);
            z-index: 1001;
            animation: fadeIn 0.2s ease;
            min-width: 160px;
            border: 1px solid var(--border-color);
        }
        
        .context-header {
            padding: 0.9rem;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .reaction-buttons {
            display: flex;
            justify-content: space-between;
            padding: 0.7rem;
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            gap: 0.2rem;
        }
        
        .reaction-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s ease;
            font-size: 1rem;
            background: none;
            border: none;
            flex-shrink: 0;
        }
        
        .reaction-btn:hover {
            transform: scale(1.2);
            background: var(--hover-bg);
        }
        
        .context-item {
            padding: 0.7rem 0.9rem;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.7rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .context-item:last-child {
            border-bottom: none;
        }
        
        .context-item:hover {
            background: var(--hover-bg);
        }
        
        .context-icon {
            width: 14px;
            text-align: center;
            color: var(--text-secondary);
        }
        
        .context-text {
            font-size: 0.8rem;
            color: var(--text-primary);
        }
        
        .context-danger {
            color: var(--danger-color);
        }
        
        .context-danger .context-icon {
            color: var(--danger-color);
        }
        
        .sticker-panel {
            display: none;
            position: fixed;
            bottom: 70px;
            left: 1rem;
            right: 1rem;
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 0.9rem;
            z-index: 1000;
            max-height: 280px;
            border: 1px solid var(--border-color);
            flex-direction: column;
        }
        
        .sticker-search {
            margin-bottom: 0.9rem;
        }
        
        .sticker-search input {
            width: 100%;
            padding: 0.7rem 0.9rem;
            border: 1px solid var(--border-color);
            border-radius: 0.7rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .sticker-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 0.9rem;
        }
        
        .sticker-tab {
            flex: 1;
            padding: 0.7rem;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            font-size: 0.8rem;
        }
        
        .sticker-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        
        .sticker-packs {
            flex: 1;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 0.7rem;
        }
        
        .sticker-pack {
            background: var(--bg-secondary);
            border-radius: 0.7rem;
            padding: 0.9rem;
            cursor: pointer;
            text-align: center;
            transition: background 0.2s ease;
        }
        
        .sticker-pack:hover {
            background: var(--hover-bg);
        }
        
        .sticker-pack img {
            width: 45px;
            height: 45px;
            object-fit: contain;
            margin-bottom: 0.4rem;
        }
        
        .sticker-pack-name {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .sticker-view {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1100;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .sticker-view-content {
            background: var(--bg-primary);
            border-radius: 0.9rem;
            padding: 1.3rem;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }
        
        .sticker-view-stickers {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 0.7rem;
            margin-bottom: 0.9rem;
        }
        
        .sticker-view-sticker {
            cursor: pointer;
            border-radius: 0.4rem;
            transition: transform 0.2s ease;
        }
        
        .sticker-view-sticker:hover {
            transform: scale(1.1);
        }
        
        .sticker-view-sticker img {
            width: 100%;
            height: auto;
        }
        
        .sticker-view-actions {
            display: flex;
            gap: 0.9rem;
            justify-content: center;
        }
        
        .close-sticker-view {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 0.7rem 1.3rem;
            border-radius: 0.7rem;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .add-sticker-pack {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 0.7rem 1.3rem;
            border-radius: 0.7rem;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 1.8rem;
            color: var(--text-secondary);
        }
        
        .loading-spinner {
            width: 36px;
            height: 36px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 0.9rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pinned-message {
            border-left: 3px solid var(--accent-color);
        }

        .pinned-message-top {
            background: var(--bg-secondary);
            border-left: 3px solid var(--accent-color);
            padding: 0.7rem;
            margin: 0 0.9rem 0.4rem 0.9rem;
            border-radius: 0.4rem;
            cursor: pointer;
            display: none;
        }
        
        .pinned-message-content {
            font-size: 0.85rem;
            color: var(--text-primary);
        }
        
        .pinned-message-info {
            font-size: 0.65rem;
            color: var(--text-secondary);
            margin-top: 0.2rem;
        }
        
        .unpin-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            float: right;
            padding: 0.1rem 0.4rem;
            font-size: 0.7rem;
        }

        .scroll-to-bottom {
            position: fixed;
            bottom: 80px;
            right: 15px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent-color);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 80;
            transition: all 0.3s ease;
            opacity: 0;
            pointer-events: none;
            font-size: 0.9rem;
        }
        
        .scroll-to-bottom.visible {
            opacity: 1;
            pointer-events: all;
        }
        
        .scroll-to-bottom:hover {
            transform: translateY(-2px);
        }
        
        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--notification-bg);
            color: var(--notification-text);
            padding: 0.7rem 1.3rem;
            border-radius: 0.9rem;
            font-size: 0.85rem;
            font-weight: 500;
            z-index: 2000;
            text-align: center;
            max-width: 80%;
            animation: notificationAppear 0.3s ease, notificationDisappear 0.3s ease 2.7s;
            pointer-events: none;
        }
        
        @keyframes notificationAppear {
            from { opacity: 0; transform: translate(-50%, -40%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }
        
        @keyframes notificationDisappear {
            from { opacity: 1; transform: translate(-50%, -50%); }
            to { opacity: 0; transform: translate(-50%, -60%); }
        }
        
        .join-group-container {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 200;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.8rem;
            text-align: center;
        }
        
        .join-group-icon {
            width: 70px;
            height: 70px;
            background: var(--accent-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.3rem;
        }
        
        .join-group-icon i {
            color: white;
            font-size: 1.8rem;
        }
        
        .join-group-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.7rem;
            color: var(--text-primary);
        }
        
        .join-group-description {
            color: var(--text-secondary);
            margin-bottom: 1.8rem;
            max-width: 350px;
            line-height: 1.5;
            font-size: 0.9rem;
        }
        
        .join-group-btn {
            padding: 0.7rem 1.8rem;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }
        
        .join-group-btn:hover {
            background: #ff6b35;
            transform: translateY(-2px);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –±–æ—Ç–∞ */
        .bot-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.8rem;
        }
        
        .bot-button {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 0.8rem;
            padding: 0.6rem 1rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            max-width: 200px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .bot-button:hover {
            background: #ff6b35;
            transform: translateY(-1px);
        }
        
        .bot-button:active {
            transform: translateY(0);
        }

        /* –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –î–õ–Ø –¢–ï–õ–ï–§–û–ù–û–í */
        @media (max-width: 480px) {
            .messages-container {
                padding: 0.7rem 0.5rem;
                padding-bottom: 90px;
            }
            
            .message {
                max-width: 85%;
            }
            
            .message.channel {
                max-width: 90%;
            }
            
            .message.bot {
                max-width: 90%;
            }
            
            .message-content {
                padding: 0.5rem 0.8rem;
            }

            .message-text {
                font-size: 0.82rem;
            }

            .message-image {
                max-width: 180px;
                max-height: 180px;
            }

            .message-sticker {
                font-size: 1.8rem;
            }

            .input-container {
                padding: 0.6rem;
            }
            
            .channel-input-container {
                padding: 0.8rem;
            }
            
            .channel-actions {
                gap: 0.5rem;
            }
            
            .channel-action-btn {
                min-width: 70px;
                padding: 0.6rem;
            }
            
            .sticker-panel {
                left: 0.5rem;
                right: 0.5rem;
                bottom: 65px;
            }
            
            .scroll-to-bottom {
                bottom: 75px;
                right: 12px;
                width: 32px;
                height: 32px;
                font-size: 0.8rem;
            }

            .call-message {
                max-width: 260px;
                padding: 0.8rem;
            }

            .call-icon {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
            
            .chat-header {
                padding: 0.7rem 0.8rem;
            }
            
            .chat-avatar {
                width: 36px;
                height: 36px;
                font-size: 0.9rem;
            }
            
            .chat-name {
                font-size: 0.9rem;
            }
            
            .bot-buttons {
                gap: 0.3rem;
            }
            
            .bot-button {
                padding: 0.5rem 0.8rem;
                font-size: 0.75rem;
                max-width: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-left">
                <button class="back-button" id="backButton">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="chat-info" id="chatInfo">
                    <div class="chat-avatar" id="chatAvatar">
                        <span id="chatAvatarInitial">C</span>
                    </div>
                    <div class="chat-details">
                        <div class="chat-name" id="chatName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        <div class="chat-status" id="chatStatus">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="call-button" id="callButton" style="display: none;">
                    <i class="fas fa-phone"></i>
                </button>
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
            </div>
        </div>
        
        <div class="join-group-container" id="joinGroupContainer">
            <div class="join-group-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="join-group-title" id="joinGroupTitle">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –≥—Ä—É–ø–ø–µ</div>
            <div class="join-group-description" id="joinGroupDescription">
                –í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–º —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ.
            </div>
            <button class="join-group-btn" id="joinGroupBtn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        </div>
        
        <div class="pinned-message-top" id="pinnedMessageTop">
            <button class="unpin-btn" id="unpinBtn">
                <i class="fas fa-times"></i>
            </button>
            <div class="pinned-message-content" id="pinnedMessageContent"></div>
            <div class="pinned-message-info" id="pinnedMessageInfo"></div>
        </div>
        
        <div class="reply-container" id="replyContainer" style="display: none;">
            <div class="reply-info">
                <div class="reply-label">–û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
                <div class="reply-content" id="replyContent"></div>
            </div>
            <button class="cancel-reply" id="cancelReply">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="messages-container" id="messagesContainer">
            <div class="loading-container" id="loadingContainer">
                <div class="loading-spinner"></div>
                <div>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
            </div>
        </div>
        
        <button class="scroll-to-bottom" id="scrollToBottom">
            <i class="fas fa-chevron-down"></i>
        </button>
        
        <div class="input-container" id="inputContainer">
            <button class="attachment-btn" id="attachmentBtn">
                <i class="fas fa-image"></i>
            </button>
            <input type="file" id="imageUpload" accept="image/*" style="display: none;">
            
            <button class="sticker-btn" id="stickerBtn">
                <i class="fas fa-smile"></i>
            </button>
            
            <div class="message-input-wrapper">
                <textarea class="message-input" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
            </div>
            
            <button class="send-button" id="sendButton" disabled>
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        
        <div class="channel-input-container" id="channelInputContainer">
            <div class="channel-actions">
                <button class="channel-action-btn" id="channelReactBtn">
                    <div class="channel-action-icon">üëç</div>
                    <div class="channel-action-text">–†–µ–∞–∫—Ü–∏–∏</div>
                </button>
                <button class="channel-action-btn" id="channelShareBtn">
                    <div class="channel-action-icon">
                        <i class="fas fa-share"></i>
                    </div>
                    <div class="channel-action-text">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</div>
                </button>
                <button class="subscribe-btn" id="subscribeBtn">
                    –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è
                </button>
            </div>
        </div>
    </div>
    
    <div class="overlay" id="overlay"></div>
    
    <div class="sticker-panel" id="stickerPanel">
        <div class="sticker-search">
            <input type="text" id="stickerSearch" placeholder="–ü–æ–∏—Å–∫ —Å—Ç–∏–∫–µ—Ä–ø–∞–∫–æ–≤...">
        </div>
        <div class="sticker-tabs">
            <button class="sticker-tab active" data-tab="saved">–ú–æ–∏ —Å—Ç–∏–∫–µ—Ä—ã</button>
            <button class="sticker-tab" data-tab="search">–ü–æ–∏—Å–∫</button>
        </div>
        <div class="sticker-packs" id="stickerPacks">
        </div>
    </div>
    
    <div class="sticker-view" id="stickerView">
        <div class="sticker-view-content">
            <h3 id="stickerPackTitle">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–∫–∞</h3>
            <div class="sticker-view-stickers" id="stickerViewStickers">
            </div>
            <div class="sticker-view-actions">
                <button class="close-sticker-view" id="closeStickerView">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button class="add-sticker-pack" id="addStickerPack">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é</button>
            </div>
        </div>
    </div>
    
    <div class="chat-menu" id="chatMenu">
        <div class="menu-item" data-action="mute">
            <div class="menu-icon">
                <i class="fas fa-bell-slash"></i>
            </div>
            <div class="menu-text" id="muteText">–û—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
        </div>
        <div class="menu-item" data-action="clear">
            <div class="menu-icon">
                <i class="fas fa-trash"></i>
            </div>
            <div class="menu-text">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</div>
        </div>
        <div class="menu-item menu-danger" data-action="leave" id="leaveChatItem" style="display: none;">
            <div class="menu-icon">
                <i class="fas fa-sign-out-alt"></i>
            </div>
            <div class="menu-text">–ü–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É</div>
        </div>
    </div>

    <div class="message-context-menu" id="messageContextMenu">
        <div class="context-header">–°–æ–æ–±—â–µ–Ω–∏–µ</div>
        <div class="reaction-buttons" id="reactionButtons">
            <!-- –†–µ–∞–∫—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
        </div>
        <div class="context-item" data-action="reply" id="replyContextItem" style="display: none;">
            <div class="context-icon">
                <i class="fas fa-reply"></i>
            </div>
            <div class="context-text">–û—Ç–≤–µ—Ç–∏—Ç—å</div>
        </div>
        <div class="context-item" data-action="copy">
            <div class="context-icon">
                <i class="fas fa-copy"></i>
            </div>
            <div class="context-text">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
        </div>
        <div class="context-item" data-action="pin" id="pinContextItem" style="display: none;">
            <div class="context-icon">
                <i class="fas fa-thumbtack"></i>
            </div>
            <div class="context-text" id="pinText">–ó–∞–∫—Ä–µ–ø–∏—Ç—å</div>
        </div>
        <div class="context-item context-danger" data-action="delete" id="deleteContextItem" style="display: none;">
            <div class="context-icon">
                <i class="fas fa-trash"></i>
            </div>
            <div class="context-text">–£–¥–∞–ª–∏—Ç—å</div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            databaseURL: "https://hamburgerchat-e8f2a-default-rtdb.firebaseio.com/"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();
        
        const ENCRYPTION_KEY = "HamburgerSecureKey2024!";
        
        let currentUser = null;
        let currentUserId = null;
        let currentChatId = null;
        let currentChatData = null;
        let isGroupChat = false;
        let isChannel = false;
        let isBotChat = false;
        let isGroupMember = false;
        let isAdmin = false;
        let isCreator = false;
        let replyingTo = null;
        let selectedMessage = null;
        let allMessages = new Map();
        let displayedMessageIds = new Set();
        let longPressTimer = null;
        let stickerPacks = JSON.parse(localStorage.getItem('hamburger_sticker_packs') || '[]');
        let allStickerPacks = [];
        let lastMessageTime = 0;
        let spamCount = 0;
        let spamResetTime = 0;
        let userProfilesCache = new Map();

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –±–æ—Ç–æ–≤
        let currentBotData = null;
        let botInstance = null;
        let botScriptUrl = null;

        // –†–µ–∞–∫—Ü–∏–∏
        const allReactions = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üò°', 'üëè', 'üî•'];

        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('hamburger_theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        });

        function encryptData(data) {
            return CryptoJS.AES.encrypt(JSON.stringify(data), ENCRYPTION_KEY).toString();
        }
        
        function decryptData(encryptedData) {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedData, ENCRYPTION_KEY);
                const decrypted = bytes.toString(CryptoJS.enc.Utf8);
                return decrypted ? JSON.parse(decrypted) : null;
            } catch (e) {
                console.log('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:', e);
                return null;
            }
        }

        function getChatIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id') || window.location.hash.substring(1) || window.location.search.substring(1);
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function getUserProfile(userId) {
            if (userProfilesCache.has(userId)) {
                return userProfilesCache.get(userId);
            }
            
            try {
                const userRef = database.ref(`users/${userId}`);
                const snapshot = await userRef.once('value');
                
                if (!snapshot.exists()) {
                    return null;
                }
                
                const userData = snapshot.val();
                const decryptedData = decryptData(userData.encryptedData);
                
                if (decryptedData) {
                    userProfilesCache.set(userId, decryptedData);
                }
                
                return decryptedData;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                return null;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞ –±–æ—Ç–∞
        async function loadBotScript(scriptUrl) {
            try {
                console.log('–ó–∞–≥—Ä—É–∂–∞—é —Å–∫—Ä–∏–ø—Ç –±–æ—Ç–∞:', scriptUrl);
                
                const response = await fetch(scriptUrl);
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞: ${response.status}`);
                }
                
                const scriptCode = await response.text();
                
                // –°–æ–∑–¥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ –∫–æ–¥–∞
                const botFunction = new Function('return ' + scriptCode)();
                botInstance = new botFunction();
                currentBotData = currentChatData;
                
                console.log('–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω:', botInstance);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (botInstance.onStart) {
                    const context = {
                        userId: currentUserId,
                        userName: currentUser,
                        chatId: currentChatId,
                        reply: async (response) => {
                            await sendBotResponse(response);
                        }
                    };
                    await botInstance.onStart(context);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–æ—Ç–∞:', error);
                await sendBotErrorMessage(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–æ—Ç–∞: ${error.message}`);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ –±–æ—Ç–∞
        async function sendBotErrorMessage(errorMessage) {
            const messageData = {
                text: `‚ùå –û—à–∏–±–∫–∞ –±–æ—Ç–∞: ${errorMessage}`,
                sender: currentChatId,
                timestamp: Date.now(),
                type: 'text',
                isBotMessage: true
            };
            
            const encrypted = encryptData(messageData);
            const messageId = Date.now().toString();
            
            await database.ref(`messages/${currentChatId}/${messageId}`).set({
                encryptedData: encrypted,
                timestamp: Date.now()
            });
        }

        window.addEventListener('DOMContentLoaded', async () => {
            currentUser = localStorage.getItem('hamburger_user');
            currentUserId = localStorage.getItem('hamburger_user_id');
            
            if (!currentUser || !currentUserId) {
                window.location.href = 'https://hamburgerchat.github.io/';
                return;
            }
            
            currentChatId = getChatIdFromUrl();
            console.log('ID —á–∞—Ç–∞ –∏–∑ URL:', currentChatId);
            
            if (!currentChatId) {
                alert('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                window.location.href = 'https://hamburgerchat.github.io/main.html';
                return;
            }
            
            await loadChatData();
            setupEventListeners();
            loadAllStickerPacks();
            setupScrollToBottom();
            setupReactionButtons();
            
            // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            setTimeout(() => {
                scrollToBottom();
            }, 500);
        });

        function setupReactionButtons() {
            const container = document.getElementById('reactionButtons');
            container.innerHTML = '';
            
            allReactions.forEach(reaction => {
                const btn = document.createElement('button');
                btn.className = 'reaction-btn';
                btn.dataset.reaction = reaction;
                btn.textContent = reaction;
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (selectedMessage) {
                        toggleReaction(selectedMessage.id, reaction);
                        closeAllModals();
                    }
                });
                container.appendChild(btn);
            });
        }

        function setupScrollToBottom() {
            const scrollBtn = document.getElementById('scrollToBottom');
            const messagesContainer = document.getElementById('messagesContainer');
            
            messagesContainer.addEventListener('scroll', () => {
                const scrollTop = messagesContainer.scrollTop;
                const scrollHeight = messagesContainer.scrollHeight;
                const clientHeight = messagesContainer.clientHeight;
                
                const isNearBottom = scrollHeight - scrollTop - clientHeight < 100;
                
                if (isNearBottom) {
                    scrollBtn.classList.remove('visible');
                } else {
                    scrollBtn.classList.add('visible');
                }
            });
            
            scrollBtn.addEventListener('click', () => {
                scrollToBottom();
            });
        }

        async function loadChatData() {
            try {
                console.log('–ó–∞–≥—Ä—É–∂–∞—é —á–∞—Ç —Å ID:', currentChatId);
                
                const chatRef = database.ref(`chats/${currentChatId}`);
                const snapshot = await chatRef.once('value');
                
                if (!snapshot.exists()) {
                    throw new Error('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
                }
                
                const chatData = snapshot.val();
                console.log('–î–∞–Ω–Ω—ã–µ —á–∞—Ç–∞:', chatData);
                
                let decryptedData = null;
                
                if (chatData.encryptedData) {
                    decryptedData = decryptData(chatData.encryptedData);
                } else if (chatData.name) {
                    decryptedData = chatData;
                }
                
                if (!decryptedData) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞');
                }
                
                currentChatData = decryptedData;
                console.log('–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', currentChatData);
                
                isGroupChat = currentChatData.type === 'group';
                isChannel = currentChatData.type === 'channel';
                isBotChat = currentChatData.type === 'bot';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
                isCreator = currentChatData.createdBy === currentUserId;
                isAdmin = isCreator || (currentChatData.admins && currentChatData.admins.includes(currentUserId));
                
                console.log('–ü—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', { isCreator, isAdmin, currentUserId, createdBy: currentChatData.createdBy, admins: currentChatData.admins });
                
                if (isGroupChat || isChannel || isBotChat) {
                    isGroupMember = currentChatData.participants && 
                                 (Array.isArray(currentChatData.participants) ? 
                                  currentChatData.participants.includes(currentUserId) : 
                                  currentChatData.participants[currentUserId]);
                } else {
                    isGroupMember = true;
                }
                
                updateChatHeader();
                
                if (isGroupMember) {
                    // –î–ª—è –±–æ—Ç–æ–≤ –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥ –±–æ—Ç–∞
                    if (isBotChat && currentChatData.botScriptUrl) {
                        await loadBotScript(currentChatData.botScriptUrl);
                    }
                    
                    await loadMessages();
                    await loadPinnedMessage();
                    document.getElementById('loadingContainer').style.display = 'none';
                    document.getElementById('joinGroupContainer').style.display = 'none';
                    
                    if (isChannel) {
                        if (isAdmin || isCreator) {
                            document.getElementById('inputContainer').style.display = 'flex';
                            document.getElementById('channelInputContainer').style.display = 'none';
                        } else {
                            document.getElementById('inputContainer').style.display = 'none';
                            document.getElementById('channelInputContainer').style.display = 'flex';
                        }
                    } else {
                        document.getElementById('inputContainer').style.display = 'flex';
                        document.getElementById('channelInputContainer').style.display = 'none';
                    }
                } else {
                    document.getElementById('loadingContainer').style.display = 'none';
                    document.getElementById('joinGroupContainer').style.display = 'flex';
                    document.getElementById('joinGroupTitle').textContent = `–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ "${currentChatData.name}"`;
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞: ' + error.message);
                window.location.href = 'https://hamburgerchat.github.io/main.html';
            }
        }

        function updateChatHeader() {
            const chatName = document.getElementById('chatName');
            const chatAvatar = document.getElementById('chatAvatar');
            const chatStatus = document.getElementById('chatStatus');
            const chatAvatarInitial = document.getElementById('chatAvatarInitial');
            const callButton = document.getElementById('callButton');
            const leaveChatItem = document.getElementById('leaveChatItem');
            
            chatName.textContent = currentChatData.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            
            if (currentChatData.avatar) {
                chatAvatar.style.backgroundImage = `url(${currentChatData.avatar})`;
                chatAvatar.classList.add('has-image');
                chatAvatarInitial.style.display = 'none';
            } else {
                const initial = currentChatData.name ? currentChatData.name.charAt(0).toUpperCase() : '?';
                chatAvatarInitial.textContent = initial;
            }
            
            // –î–ª—è –∫–∞–Ω–∞–ª–æ–≤ –º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –∞–≤–∞—Ç–∞—Ä–∫–∏
            if (isChannel) {
                chatAvatar.classList.add('channel');
                if (!currentChatData.avatar) {
                    const channelInitial = currentChatData.name ? currentChatData.name.charAt(0).toUpperCase() : 'C';
                    chatAvatarInitial.textContent = channelInitial;
                }
            }
            
            // –î–ª—è –±–æ—Ç–æ–≤ –º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –∞–≤–∞—Ç–∞—Ä–∫–∏
            if (isBotChat) {
                chatAvatar.classList.add('bot');
                if (!currentChatData.avatar) {
                    const botInitial = currentChatData.name ? currentChatData.name.charAt(0).toUpperCase() : 'B';
                    chatAvatarInitial.textContent = botInitial;
                }
            }
            
            if (isGroupChat || isChannel || isBotChat) {
                const participants = currentChatData.participants || [];
                const count = Array.isArray(participants) ? participants.length : Object.keys(participants).length;
                let chatType = '–≥—Ä—É–ø–ø–∞';
                if (isChannel) chatType = '–∫–∞–Ω–∞–ª';
                if (isBotChat) chatType = '–±–æ—Ç';
                
                chatStatus.innerHTML = `<span class="online-indicator"></span> ${count} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ‚Ä¢ ${chatType}`;
                leaveChatItem.style.display = 'block';
                callButton.style.display = 'none';
            } else {
                // –î–ª—è –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
                loadOtherUserData();
                callButton.style.display = 'flex';
                leaveChatItem.style.display = 'none';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –¥–ª—è –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤
        async function loadOtherUserData() {
            if (!currentChatData.participants) return;
            
            const otherUserId = Object.keys(currentChatData.participants).find(id => id !== currentUserId);
            if (!otherUserId) return;
            
            try {
                const userProfile = await getUserProfile(otherUserId);
                if (userProfile) {
                    const chatAvatar = document.getElementById('chatAvatar');
                    const chatAvatarInitial = document.getElementById('chatAvatarInitial');
                    const chatStatus = document.getElementById('chatStatus');
                    
                    if (userProfile.avatar) {
                        chatAvatar.style.backgroundImage = `url(${userProfile.avatar})`;
                        chatAvatar.classList.add('has-image');
                        chatAvatarInitial.style.display = 'none';
                    } else {
                        chatAvatarInitial.textContent = userProfile.username ? userProfile.username.charAt(0).toUpperCase() : 'U';
                    }
                    
                    // –°—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω/–æ—Ñ–ª–∞–π–Ω
                    const isOnline = Math.random() > 0.3;
                    if (isOnline) {
                        chatStatus.innerHTML = `<span class="online-indicator"></span> –≤ —Å–µ—Ç–∏`;
                    } else {
                        chatStatus.innerHTML = `–±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ`;
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤
        function updateSubscribeButton() {
            const subscribeBtn = document.getElementById('subscribeBtn');
            if (isGroupMember) {
                subscribeBtn.textContent = '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è';
                subscribeBtn.classList.add('unsubscribe');
            } else {
                subscribeBtn.textContent = '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è';
                subscribeBtn.classList.remove('unsubscribe');
            }
        }

        async function loadMessages() {
            const messagesRef = database.ref(`messages/${currentChatId}`);
            
            const snapshot = await messagesRef.once('value');
            if (snapshot.exists()) {
                const messages = snapshot.val();
                for (const messageId in messages) {
                    processMessage(messageId, messages[messageId]);
                }
            }
            
            messagesRef.on('child_added', (snapshot) => {
                processMessage(snapshot.key, snapshot.val());
            });

            messagesRef.on('child_changed', (snapshot) => {
                processMessage(snapshot.key, snapshot.val(), true);
            });
        }

        function processMessage(messageId, messageData, isUpdate = false) {
            if (displayedMessageIds.has(messageId) && !isUpdate) {
                return;
            }
            
            let decrypted = null;
            
            if (messageData.encryptedData) {
                decrypted = decryptData(messageData.encryptedData);
            } else if (messageData.text || messageData.type === 'service' || messageData.type === 'call') {
                decrypted = messageData;
            }
            
            if (decrypted) {
                const message = { id: messageId, ...decrypted };
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–∞—Ä—Ç—É
                allMessages.set(messageId, message);
                displayedMessageIds.add(messageId);
                
                if (isUpdate) {
                    updateMessageDisplay(message);
                } else {
                    displayMessage(message);
                }
            }
        }

        async function displayMessage(message) {
            const container = document.getElementById('messagesContainer');
            
            const noMessages = container.querySelector('.no-messages');
            if (noMessages) noMessages.remove();
            
            if (message.type === 'call') {
                displayCallMessage(message);
                return;
            }

            const messageEl = document.createElement('div');
            
            if (message.type === 'service') {
                displayServiceMessage(message);
                return;
            }

            const isOwn = message.sender === currentUserId;
            const isChannelMessage = isChannel && message.sender === currentChatData.createdBy;
            const isBotMessage = message.isBotMessage || message.sender === currentChatId;
            const showHeader = (isGroupChat && !isOwn) || (isChannel && !isChannelMessage) || (isBotChat && !isBotMessage);
            
            messageEl.className = `message ${isOwn ? 'own' : ''} ${isChannel ? 'channel' : ''} ${isBotChat ? 'bot' : ''} ${isGroupChat ? 'group' : ''} ${message.pinned ? 'pinned-message' : ''} ${isBotMessage ? 'bot-message' : ''}`;
            messageEl.dataset.messageId = message.id;
            messageEl.dataset.timestamp = message.timestamp;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∫–∏
            let senderAvatar = '';
            let senderName = message.sender;
            let senderRole = '';
            
            if (showHeader) {
                try {
                    // –î–ª—è –±–æ—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ currentChatData
                    if (isBotMessage) {
                        senderName = currentChatData.name || '–ë–æ—Ç';
                    } else {
                        const userProfile = await getUserProfile(message.sender);
                        if (userProfile) {
                            senderName = userProfile.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                            
                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–æ–ª—å –≤ –≥—Ä—É–ø–ø–µ/–∫–∞–Ω–∞–ª–µ
                            if (isGroupChat || isChannel) {
                                if (message.sender === currentChatData.createdBy) {
                                    senderRole = '<div class="message-role role-creator">–°–æ–∑–¥–∞—Ç–µ–ª—å</div>';
                                } else if (currentChatData.admins && currentChatData.admins.includes(message.sender)) {
                                    senderRole = '<div class="message-role role-admin">–ê–¥–º–∏–Ω</div>';
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è:', error);
                }
            }
            
            let avatar = '';
            if (showHeader && !isChannelMessage && !isBotMessage) {
                const userProfile = await getUserProfile(message.sender);
                const avatarUrl = userProfile ? userProfile.avatar : null;
                const avatarInitial = userProfile && userProfile.username ? userProfile.username.charAt(0).toUpperCase() : 'U';
                
                avatar = `<div class="message-avatar" onclick="openUserProfile('${message.sender}')" style="${avatarUrl ? `background-image: url(${avatarUrl})` : ''}">${avatarUrl ? '' : avatarInitial}</div>`;
            } else if (isBotMessage) {
                // –ê–≤–∞—Ç–∞—Ä–∫–∞ –¥–ª—è –±–æ—Ç–∞
                const avatarUrl = currentChatData.avatar;
                const avatarInitial = currentChatData.name ? currentChatData.name.charAt(0).toUpperCase() : 'B';
                
                avatar = `<div class="message-avatar" onclick="openBotProfile()" style="${avatarUrl ? `background-image: url(${avatarUrl})` : ''}">${avatarUrl ? '' : avatarInitial}</div>`;
            }
            
            let replyContent = '';
            if (message.replyTo) {
                const repliedMessage = allMessages.get(message.replyTo);
                if (repliedMessage) {
                    replyContent = `
                        <div class="reply-preview" onclick="scrollToMessage('${message.replyTo}')">
                            <div class="reply-sender">${repliedMessage.senderName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
                            <div class="reply-text">${repliedMessage.text || '–°–æ–æ–±—â–µ–Ω–∏–µ'}</div>
                        </div>
                    `;
                }
            }
            
            let reactions = '';
            if (message.reactions && Object.keys(message.reactions).length > 0) {
                reactions = `<div class="reactions">${
                    Object.entries(message.reactions).map(([emoji, users]) => {
                        const userList = Array.isArray(users) ? users.join(', ') : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏';
                        const hasUserReaction = Array.isArray(users) ? users.includes(currentUserId) : false;
                        const reactionClass = hasUserReaction ? ' user-reaction' : '';
                        return `
                            <div class="reaction${reactionClass}" onclick="toggleReaction('${message.id}', '${emoji}')">
                                ${emoji} <span class="reaction-count">${Array.isArray(users) ? users.length : 1}</span>
                                <div class="reaction-users">${userList}</div>
                            </div>
                        `;
                    }).join('')
                }</div>`;
            }
            
            let statusIcons = '';
            if (isOwn) {
                if (message.readBy && message.readBy.length > 0) {
                    statusIcons = '<div class="message-status"><i class="fas fa-check-double status-icon read"></i><i class="fas fa-check-double status-icon read"></i></div>';
                } else if (message.delivered) {
                    statusIcons = '<div class="message-status"><i class="fas fa-check-double status-icon"></i><i class="fas fa-check-double status-icon"></i></div>';
                } else {
                    statusIcons = '<div class="message-status"><i class="fas fa-check status-icon"></i></div>';
                }
            }
            
            let messageText = message.text || '';
            if (messageText) {
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                messageText = messageText.replace(urlRegex, '<a href="$1" target="_blank" onclick="event.stopPropagation()">$1</a>');
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –±–æ—Ç–∞ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            let botButtons = '';
            if (message.botButtons && Array.isArray(message.botButtons)) {
                botButtons = `<div class="bot-buttons">${
                    message.botButtons.flat().map(buttonRow => 
                        buttonRow.map(button => {
                            if (button.type === "text") {
                                return `<button class="bot-button" data-payload="${button.payload}">${button.label}</button>`;
                            }
                            return '';
                        }).join('')
                    ).join('')
                }</div>`;
            }
            
            let content = '';
            if (message.image) {
                content = `
                    ${replyContent}
                    ${showHeader ? `<div class="message-header">
                        <div class="sender-name" onclick="${isBotMessage ? 'openBotProfile()' : `openUserProfile('${message.sender}')`}">${senderName}</div>
                        ${senderRole}
                    </div>` : ''}
                    <img src="${message.image}" class="message-image" onclick="openImage('${message.image}')">
                    ${messageText ? `<div class="message-text">${messageText}</div>` : ''}
                    ${botButtons}
                    ${reactions}
                    <div class="message-time">${formatTime(message.timestamp)} ${statusIcons}</div>
                `;
            } else if (message.sticker) {
                content = `
                    ${replyContent}
                    ${showHeader ? `<div class="message-header">
                        <div class="sender-name" onclick="${isBotMessage ? 'openBotProfile()' : `openUserProfile('${message.sender}')`}">${senderName}</div>
                        ${senderRole}
                    </div>` : ''}
                    <div class="message-sticker">${message.sticker}</div>
                    ${botButtons}
                    ${reactions}
                    <div class="message-time">${formatTime(message.timestamp)} ${statusIcons}</div>
                `;
            } else {
                content = `
                    ${replyContent}
                    ${showHeader ? `<div class="message-header">
                        <div class="sender-name" onclick="${isBotMessage ? 'openBotProfile()' : `openUserProfile('${message.sender}')`}">${senderName}</div>
                        ${senderRole}
                    </div>` : ''}
                    <div class="message-text">${messageText}</div>
                    ${botButtons}
                    ${reactions}
                    <div class="message-time">${formatTime(message.timestamp)} ${statusIcons}</div>
                `;
            }
            
            messageEl.innerHTML = `${avatar}<div class="message-content">${content}</div>`;
            
            setupMessageInteractions(messageEl, message);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –±–æ—Ç–∞
            if (message.botButtons) {
                messageEl.querySelectorAll('.bot-button').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const payload = button.dataset.payload;
                        await handleBotButtonClick(payload);
                    });
                });
            }
            
            container.appendChild(messageEl);
            
            // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            if (!message.delivered && !isUpdate) {
                scrollToBottom();
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ –±–æ—Ç–∞
        async function handleBotButtonClick(payload) {
            try {
                // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å payload
                const messageData = {
                    text: `[–ö–Ω–æ–ø–∫–∞: ${payload}]`,
                    sender: currentUserId,
                    timestamp: Date.now(),
                    type: 'text',
                    buttonPayload: payload,
                    delivered: false
                };
                
                const encrypted = encryptData(messageData);
                const messageId = Date.now().toString();
                
                await database.ref(`messages/${currentChatId}/${messageId}`).set({
                    encryptedData: encrypted,
                    timestamp: Date.now()
                });
                
                setTimeout(async () => {
                    messageData.delivered = true;
                    const updatedEncrypted = encryptData(messageData);
                    await database.ref(`messages/${currentChatId}/${messageId}`).update({
                        encryptedData: updatedEncrypted
                    });
                }, 1000);
                
                await updateLastMessage(messageData.text);
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ –±–æ—Ç–æ–º
                if (isBotChat && botInstance && botInstance.onMessage) {
                    const context = {
                        userId: currentUserId,
                        userName: currentUser,
                        chatId: currentChatId,
                        messageId: messageId,
                        reply: async (response) => {
                            await sendBotResponse(response);
                        },
                        buttonPayload: payload
                    };
                    
                    await botInstance.onMessage({ text: '' }, context);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–Ω–æ–ø–∫–∏ –±–æ—Ç–∞:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –±–æ—Ç–∞
        async function sendBotResponse(response) {
            try {
                let messageData = {
                    text: response.text || '',
                    sender: currentChatId,
                    timestamp: Date.now(),
                    type: 'text',
                    isBotMessage: true,
                    delivered: true
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                if (response.buttons && response.buttons.length > 0) {
                    messageData.botButtons = response.buttons;
                }
                
                const encrypted = encryptData(messageData);
                const messageId = Date.now().toString();
                
                await database.ref(`messages/${currentChatId}/${messageId}`).set({
                    encryptedData: encrypted,
                    timestamp: Date.now()
                });
                
                await updateLastMessage(messageData.text || '–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ –±–æ—Ç–∞:', error);
            }
        }

        function displayCallMessage(message) {
            const container = document.getElementById('messagesContainer');
            const callEl = document.createElement('div');
            callEl.className = 'message call-message';
            callEl.dataset.messageId = message.id;
            
            const isIncoming = message.sender !== currentUserId;
            const callTitle = isIncoming ? '–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫' : '–ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫';
            
            let callDescription = '';
            if (isIncoming) {
                callDescription = `${message.senderName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} –∑–≤–æ–Ω–∏—Ç –≤–∞–º`;
            } else {
                callDescription = '–í—ã –∑–≤–æ–Ω–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É';
            }
            
            callEl.innerHTML = `
                <div class="call-message-content">
                    <div class="call-icon">
                        <i class="fas fa-phone"></i>
                    </div>
                    <div class="call-title">${callTitle}</div>
                    <div class="call-description">${callDescription}</div>
                    ${isIncoming ? `
                        <div class="call-buttons">
                            <button class="call-accept-btn" onclick="acceptCall('${message.callId}')">
                                <i class="fas fa-phone"></i> –ü—Ä–∏–Ω—è—Ç—å
                            </button>
                            <button class="call-decline-btn" onclick="declineCall('${message.id}')">
                                <i class="fas fa-times"></i> –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                            </button>
                        </div>
                    ` : `
                        <div class="call-buttons">
                            <button class="call-decline-btn" onclick="cancelCall('${message.id}')">
                                <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∏—Ç—å
                            </button>
                        </div>
                    `}
                    <div class="message-time">${formatTime(message.timestamp)}</div>
                </div>
            `;
            
            container.appendChild(callEl);
            scrollToBottom();
        }

        function updateMessageDisplay(message) {
            const existingMessage = document.querySelector(`[data-message-id="${message.id}"]`);
            if (existingMessage) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞
                const container = document.getElementById('messagesContainer');
                const scrollBefore = container.scrollTop;
                const scrollHeightBefore = container.scrollHeight;
                
                existingMessage.remove();
                displayMessage(message);
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞
                const scrollHeightAfter = container.scrollHeight;
                const scrollDiff = scrollHeightAfter - scrollHeightBefore;
                container.scrollTop = scrollBefore + scrollDiff;
            }
        }

        function displayServiceMessage(message) {
            const container = document.getElementById('messagesContainer');
            const serviceEl = document.createElement('div');
            serviceEl.className = 'service-message';
            serviceEl.innerHTML = `<div class="service-content">${message.text}</div>`;
            container.appendChild(serviceEl);
        }

        function setupMessageInteractions(messageEl, message) {
            const contentEl = messageEl.querySelector('.message-content');
            
            contentEl.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showMessageContextMenu(e, message);
            });
            
            contentEl.addEventListener('mousedown', (e) => {
                if (e.button === 0) {
                    longPressTimer = setTimeout(() => {
                        showMessageContextMenu(e, message);
                    }, 500);
                }
            });
            
            contentEl.addEventListener('mouseup', clearLongPressTimer);
            contentEl.addEventListener('mouseleave', clearLongPressTimer);
            
            contentEl.addEventListener('touchstart', (e) => {
                longPressTimer = setTimeout(() => {
                    showMessageContextMenu(e.touches[0], message);
                }, 500);
            });
            
            contentEl.addEventListener('touchend', clearLongPressTimer);
            contentEl.addEventListener('touchmove', clearLongPressTimer);
        }

        function clearLongPressTimer() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }

        function openUserProfile(userId) {
            window.open(`https://hamburgerchat.github.io/profile.html?id=${userId}`, '_blank');
        }

        function openBotProfile() {
            window.open(`https://hamburgerchat.github.io/profile.html?id=${currentChatId}`, '_blank');
        }

        function showMessageContextMenu(event, message) {
            clearLongPressTimer();
            selectedMessage = message;
            const menu = document.getElementById('messageContextMenu');
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∞–≤
            const isOwnMessage = message.sender === currentUserId;
            const canModify = isOwnMessage || isAdmin || isCreator;
            
            const replyContextItem = document.getElementById('replyContextItem');
            const pinContextItem = document.getElementById('pinContextItem');
            const deleteContextItem = document.getElementById('deleteContextItem');
            
            // –í –∫–∞–Ω–∞–ª–∞—Ö –æ–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ —Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∞–∫—Ü–∏–∏
            if (isChannel && !isAdmin && !isCreator) {
                replyContextItem.style.display = 'none';
                pinContextItem.style.display = 'none';
                deleteContextItem.style.display = 'none';
            } else {
                replyContextItem.style.display = 'flex';
                pinContextItem.style.display = canModify ? 'flex' : 'none';
                deleteContextItem.style.display = canModify ? 'flex' : 'none';
            }
            
            const pinText = document.getElementById('pinText');
            pinText.textContent = message.pinned ? '–û—Ç–∫—Ä–µ–ø–∏—Ç—å' : '–ó–∞–∫—Ä–µ–ø–∏—Ç—å';
            
            menu.style.display = 'block';
            
            const x = event.clientX || (event.touches && event.touches[0].clientX) || 100;
            const y = event.clientY || (event.touches && event.touches[0].clientY) || 100;
            
            menu.style.left = Math.min(x, window.innerWidth - 200) + 'px';
            menu.style.top = Math.min(y, window.innerHeight - 300) + 'px';
            
            document.getElementById('overlay').style.display = 'block';
        }

        async function loadPinnedMessage() {
            try {
                const pinnedRef = database.ref(`pinnedMessages/${currentChatId}`);
                const snapshot = await pinnedRef.once('value');
                
                if (snapshot.exists()) {
                    const pinnedData = snapshot.val();
                    const decryptedData = decryptData(pinnedData.encryptedData);
                    
                    if (decryptedData) {
                        document.getElementById('pinnedMessageTop').style.display = 'block';
                        document.getElementById('pinnedMessageContent').textContent = 
                            decryptedData.type === 'sticker' ? 'üìé –°—Ç–∏–∫–µ—Ä' : (decryptedData.text || '–°–æ–æ–±—â–µ–Ω–∏–µ');
                        document.getElementById('pinnedMessageInfo').textContent = 
                            `–ó–∞–∫—Ä–µ–ø–∏–ª: ${decryptedData.pinnedBy} ‚Ä¢ ${formatTime(decryptedData.pinnedAt)}`;
                    }
                } else {
                    document.getElementById('pinnedMessageTop').style.display = 'none';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            }
        }

        async function pinMessage(messageId) {
            try {
                const message = allMessages.get(messageId);
                if (!message) return;
                
                const pinnedData = {
                    messageId: messageId,
                    text: message.text,
                    type: message.type,
                    sender: message.sender,
                    pinnedBy: currentUser,
                    pinnedAt: Date.now(),
                    timestamp: message.timestamp
                };
                
                const encryptedPinnedData = encryptData(pinnedData);
                
                await database.ref(`pinnedMessages/${currentChatId}`).set({
                    encryptedData: encryptedPinnedData,
                    pinnedAt: Date.now()
                });
                
                loadPinnedMessage();
                
                showNotification(`${currentUser} –∑–∞–∫—Ä–µ–ø–∏–ª(–∞) —Å–æ–æ–±—â–µ–Ω–∏–µ`);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
            }
        }

        async function unpinMessage() {
            try {
                await database.ref(`pinnedMessages/${currentChatId}`).remove();
                loadPinnedMessage();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            }
        }

        function scrollToPinnedMessage() {
            const pinnedRef = database.ref(`pinnedMessages/${currentChatId}`);
            pinnedRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    const pinnedData = snapshot.val();
                    const decryptedData = decryptData(pinnedData.encryptedData);
                    if (decryptedData) {
                        scrollToMessage(decryptedData.messageId);
                    }
                }
            });
        }

        async function loadAllStickerPacks() {
            try {
                const response = await fetch('https://api.allorigins.win/raw?url=https://bdd.somroti-yt.workers.dev/get/HMBR_AllStickers');
                allStickerPacks = await response.json();
                displaySavedStickers();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∏–∫–µ—Ä–ø–∞–∫–æ–≤:', error);
            }
        }

        function displaySavedStickers() {
            const container = document.getElementById('stickerPacks');
            container.innerHTML = '';
            
            if (stickerPacks.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fas fa-sticker" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <div>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å—Ç–∏–∫–µ—Ä–ø–∞–∫–æ–≤</div>
                        <div style="font-size: 0.8rem; margin-top: 0.5rem;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∫–ª–∞–¥–∫—É "–ü–æ–∏—Å–∫" —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Å—Ç–∏–∫–µ—Ä—ã</div>
                    </div>
                `;
                return;
            }
            
            stickerPacks.forEach(packName => {
                const packElement = document.createElement('div');
                packElement.className = 'sticker-pack';
                packElement.innerHTML = `
                    <div style="width: 50px; height: 50px; background: var(--accent-gradient); border-radius: 0.5rem; margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-sticker" style="color: white; font-size: 1.5rem;"></i>
                    </div>
                    <div class="sticker-pack-name">${packName}</div>
                `;
                
                packElement.addEventListener('click', () => {
                    loadStickerPack(packName);
                });
                
                container.appendChild(packElement);
            });
        }

        function displaySearchStickers() {
            const container = document.getElementById('stickerPacks');
            container.innerHTML = '';
            
            allStickerPacks.forEach(packName => {
                const isSaved = stickerPacks.includes(packName);
                const packElement = document.createElement('div');
                packElement.className = 'sticker-pack';
                packElement.innerHTML = `
                    <div style="width: 50px; height: 50px; background: ${isSaved ? 'var(--success-color)' : 'var(--accent-gradient)'}; border-radius: 0.5rem; margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-sticker" style="color: white; font-size: 1.5rem;"></i>
                    </div>
                    <div class="sticker-pack-name">${packName}</div>
                    ${isSaved ? '<div style="font-size: 0.7rem; color: var(--success-color);">‚úì –í –∫–æ–ª–ª–µ–∫—Ü–∏–∏</div>' : ''}
                `;
                
                packElement.addEventListener('click', () => {
                    loadStickerPack(packName);
                });
                
                container.appendChild(packElement);
            });
        }

        async function loadStickerPack(packName) {
            try {
                const response = await fetch(`https://api.allorigins.win/raw?url=https://bdd.somroti-yt.workers.dev/get/HMBR_StickerPack_${encodeURIComponent(packName)}`);
                const packData = await response.json();
                
                document.getElementById('stickerPackTitle').textContent = `${packData.name} by ${packData.author}`;
                document.getElementById('stickerViewStickers').innerHTML = '';
                
                packData.stickers.forEach((stickerUrl, index) => {
                    const stickerElement = document.createElement('div');
                    stickerElement.className = 'sticker-view-sticker';
                    stickerElement.innerHTML = `<img src="${stickerUrl}" alt="–°—Ç–∏–∫–µ—Ä ${index + 1}" style="width: 100%; height: auto;">`;
                    
                    stickerElement.addEventListener('click', () => {
                        sendStickerAsImage(stickerUrl);
                    });
                    
                    document.getElementById('stickerViewStickers').appendChild(stickerElement);
                });
                
                document.getElementById('stickerView').style.display = 'flex';
                const isSaved = stickerPacks.includes(packName);
                document.getElementById('addStickerPack').style.display = isSaved ? 'none' : 'block';
                document.getElementById('addStickerPack').onclick = () => addStickerPack(packName);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∏–∫–µ—Ä–ø–∞–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∏–∫–µ—Ä–ø–∞–∫–∞');
            }
        }

        function addStickerPack(packName) {
            if (!stickerPacks.includes(packName)) {
                stickerPacks.push(packName);
                localStorage.setItem('hamburger_sticker_packs', JSON.stringify(stickerPacks));
                alert(`–°—Ç–∏–∫–µ—Ä–ø–∞–∫ "${packName}" –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é!`);
                document.getElementById('addStickerPack').style.display = 'none';
                
                const activeTab = document.querySelector('.sticker-tab.active').dataset.tab;
                if (activeTab === 'search') {
                    displaySearchStickers();
                }
            }
        }

        async function sendStickerAsImage(stickerUrl) {
            // –í –∫–∞–Ω–∞–ª–∞—Ö –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –∏ —Å–æ–∑–¥–∞—Ç–µ–ª—å
            if (isChannel && !isAdmin && !isCreator) {
                alert('–í –∫–∞–Ω–∞–ª–∞—Ö –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã');
                return;
            }
            
            if (!isGroupMember && (isGroupChat || isChannel || isBotChat)) {
                alert('–í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–º —ç—Ç–æ–≥–æ —á–∞—Ç–∞');
                return;
            }
            
            try {
                const apiKey = "02cf7a0dc37b8a8adaedc9784752a3db";
                const formData = new FormData();
                
                const response = await fetch(stickerUrl);
                const blob = await response.blob();
                
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                
                reader.onload = async function() {
                    const base64 = reader.result.split(',')[1];
                    
                    formData.append("image", base64);
                    formData.append("key", apiKey);

                    const uploadResponse = await fetch("https://api.imgbb.com/1/upload", {
                        method: "POST",
                        body: formData,
                    });
                    
                    const data = await uploadResponse.json();
                    const imageUrl = data.data?.url;
                    
                    if (!imageUrl) throw new Error('–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∏–∫–µ—Ä–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å');
                    
                    const messageData = {
                        image: imageUrl,
                        sender: currentUserId,
                        timestamp: Date.now(),
                        type: 'image',
                        delivered: false
                    };
                    
                    const encrypted = encryptData(messageData);
                    const messageId = Date.now().toString();
                    
                    await database.ref(`messages/${currentChatId}/${messageId}`).set({
                        encryptedData: encrypted,
                        timestamp: Date.now()
                    });
                    
                    setTimeout(async () => {
                        messageData.delivered = true;
                        const updatedEncrypted = encryptData(messageData);
                        await database.ref(`messages/${currentChatId}/${messageId}`).update({
                            encryptedData: updatedEncrypted
                        });
                    }, 1000);
                    
                    await updateLastMessage('–°—Ç–∏–∫–µ—Ä');
                    
                    closeAllModals();
                };
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∏–∫–µ—Ä–∞:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∏–∫–µ—Ä–∞: ' + error.message);
            }
        }

        function setupEventListeners() {
            document.getElementById('backButton').addEventListener('click', () => {
                window.location.href = 'https://hamburgerchat.github.io/main.html';
            });
            
            document.getElementById('callButton').addEventListener('click', startCall);
            
            document.getElementById('menuToggle').addEventListener('click', (e) => {
                e.stopPropagation();
                const menu = document.getElementById('chatMenu');
                menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
                document.getElementById('overlay').style.display = 'block';
            });
            
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    handleMenuAction(this.dataset.action);
                });
            });
            
            document.querySelectorAll('.context-item, .reaction-btn').forEach(item => {
                item.addEventListener('click', function() {
                    handleContextAction(this.dataset.action || this.dataset.reaction);
                });
            });
            
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendButton');
            
            input.addEventListener('input', function() {
                sendBtn.disabled = !this.value.trim();
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });
            
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!sendBtn.disabled) sendMessage();
                }
            });
            
            sendBtn.addEventListener('click', sendMessage);
            
            document.getElementById('attachmentBtn').addEventListener('click', () => {
                document.getElementById('imageUpload').click();
            });
            
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
            
            document.getElementById('stickerBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                const panel = document.getElementById('stickerPanel');
                panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
                displaySavedStickers();
            });
            
            document.querySelectorAll('.sticker-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.sticker-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    if (this.dataset.tab === 'saved') {
                        displaySavedStickers();
                    } else {
                        displaySearchStickers();
                    }
                });
            });
            
            document.getElementById('stickerSearch').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                const packs = document.querySelectorAll('.sticker-pack');
                const activeTab = document.querySelector('.sticker-tab.active').dataset.tab;
                
                packs.forEach(pack => {
                    const name = pack.querySelector('.sticker-pack-name').textContent.toLowerCase();
                    pack.style.display = name.includes(query) ? 'block' : 'none';
                });
            });
            
            document.getElementById('closeStickerView').addEventListener('click', closeStickerView);
            
            document.getElementById('cancelReply').addEventListener('click', cancelReply);
            
            document.getElementById('overlay').addEventListener('click', closeAllModals);
            
            document.getElementById('chatInfo').addEventListener('click', () => {
                if (isGroupChat || isChannel || isBotChat) {
                    window.open(`https://hamburgerchat.github.io/profile.html?id=${currentChatId}`, '_blank');
                } else {
                    const otherUserId = Object.keys(currentChatData.participants).find(id => id !== currentUserId);
                    if (otherUserId) {
                        window.open(`https://hamburgerchat.github.io/profile.html?id=${otherUserId}`, '_blank');
                    }
                }
            });

            document.getElementById('pinnedMessageTop').addEventListener('click', scrollToPinnedMessage);
            document.getElementById('unpinBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                unpinMessage();
            });
            
            document.getElementById('joinGroupBtn').addEventListener('click', joinGroup);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤
            document.getElementById('channelReactBtn').addEventListener('click', () => {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Ä–µ–∞–∫—Ü–∏–π –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                const messages = Array.from(allMessages.values());
                if (messages.length > 0) {
                    const lastMessage = messages[messages.length - 1];
                    showQuickReactions(lastMessage);
                }
            });
            
            document.getElementById('channelShareBtn').addEventListener('click', () => {
                const chatLink = `https://hamburgerchat.github.io/chat.html?id=${currentChatId}`;
                navigator.clipboard.writeText(chatLink).then(() => {
                    showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
                });
            });
            
            document.getElementById('subscribeBtn').addEventListener('click', toggleSubscription);
        }
        
        // –ë—ã—Å—Ç—Ä—ã–µ —Ä–µ–∞–∫—Ü–∏–∏ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤
        function showQuickReactions(message) {
            const reactionMenu = document.createElement('div');
            reactionMenu.className = 'message-context-menu';
            reactionMenu.style.position = 'fixed';
            reactionMenu.style.bottom = '100px';
            reactionMenu.style.left = '50%';
            reactionMenu.style.transform = 'translateX(-50%)';
            reactionMenu.innerHTML = `
                <div class="reaction-buttons">
                    ${allReactions.map(reaction => `
                        <button class="reaction-btn" data-reaction="${reaction}">${reaction}</button>
                    `).join('')}
                </div>
            `;
            
            document.body.appendChild(reactionMenu);
            document.getElementById('overlay').style.display = 'block';
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–µ–∞–∫—Ü–∏–π
            reactionMenu.querySelectorAll('.reaction-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleReaction(message.id, btn.dataset.reaction);
                    document.body.removeChild(reactionMenu);
                    document.getElementById('overlay').style.display = 'none';
                });
            });
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
            document.getElementById('overlay').addEventListener('click', () => {
                if (document.body.contains(reactionMenu)) {
                    document.body.removeChild(reactionMenu);
                }
            }, { once: true });
        }
        
        // –ü–æ–¥–ø–∏—Å–∫–∞/–æ—Ç–ø–∏—Å–∫–∞ –æ—Ç –∫–∞–Ω–∞–ª–∞
        async function toggleSubscription() {
            try {
                if (isGroupMember) {
                    // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è
                    await database.ref(`userChats/${currentUserId}/${currentChatId}`).remove();
                    isGroupMember = false;
                    updateSubscribeButton();
                    showNotification('–í—ã –æ—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç –∫–∞–Ω–∞–ª–∞');
                    
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
                    setTimeout(() => {
                        window.location.href = 'https://hamburgerchat.github.io/main.html';
                    }, 1000);
                } else {
                    // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è
                    await joinGroup();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏:', error);
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        async function startCall() {
            if (isGroupChat || isChannel || isBotChat) {
                alert('–ó–≤–æ–Ω–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–Ω—ã—Ö —á–∞—Ç–∞—Ö');
                return;
            }
            
            if (!isGroupMember) {
                alert('–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∑–≤–æ–Ω–∏—Ç—å –≤ —ç—Ç–æ–º —á–∞—Ç–µ');
                return;
            }
            
            try {
                const callId = 'call_' + Date.now();
                
                const otherUserId = Object.keys(currentChatData.participants).find(id => id !== currentUserId);
                if (!otherUserId) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞');
                }

                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const userProfile = await getUserProfile(otherUserId);
                const username = userProfile ? userProfile.username : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                const avatarInitial = userProfile && userProfile.username ? userProfile.username.charAt(0).toUpperCase() : 'U';

                // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–≤–æ–Ω–∫–∞ –ø–æ –Ω–æ–≤–æ–π —Å—Ö–µ–º–µ
                const callData = {
                    id: callId,
                    from: currentUserId,
                    to: otherUserId,
                    participants: [currentUserId, otherUserId],
                    status: 'waiting',
                    createdAt: Date.now(),
                    chatId: currentChatId,
                    callerName: currentUser,
                    receiverName: username
                };

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase –ø–æ –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ
                await database.ref(`calls/${callId}`).set({
                    from: currentUserId,
                    to: otherUserId,
                    offer: null,
                    status: 'waiting',
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    callerName: currentUser,
                    receiverName: username
                });

                // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–≤–æ–Ω–∫–µ
                const callMessageData = {
                    type: 'call',
                    callId: callId,
                    sender: currentUserId,
                    timestamp: Date.now(),
                    status: 'waiting',
                    callerName: currentUser,
                    receiverName: username
                };
                
                const encrypted = encryptData(callMessageData);
                const messageId = Date.now().toString();
                
                await database.ref(`messages/${currentChatId}/${messageId}`).set({
                    encryptedData: encrypted,
                    timestamp: Date.now()
                });
                
                await updateLastMessage('üìû –ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫');
                
                showNotification('–ó–≤–æ–Ω–æ–∫ –Ω–∞—á–∞—Ç');
                
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–≤–æ–Ω–∫–∞
                window.location.href = `https://hamburgerchat.github.io/call.html?id=${callId}`;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∑–≤–æ–Ω–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –∑–≤–æ–Ω–∫–∞: ' + error.message);
            }
        }
        
        function acceptCall(callId) {
            window.location.href = `https://hamburgerchat.github.io/call.html?id=${callId}`;
        }
        
        async function declineCall(messageId) {
            try {
                await database.ref(`messages/${currentChatId}/${messageId}`).remove();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞:', error);
            }
        }
        
        async function cancelCall(messageId) {
            try {
                await database.ref(`messages/${currentChatId}/${messageId}`).remove();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–≤–æ–Ω–∫–∞:', error);
            }
        }
        
        function handleContextAction(action) {
            if (!selectedMessage) return;
            
            switch (action) {
                case 'reply':
                    setReplyTo(selectedMessage);
                    break;
                case 'copy':
                    navigator.clipboard.writeText(selectedMessage.text || '');
                    showNotification('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
                    break;
                case 'pin':
                    if (selectedMessage.pinned) {
                        unpinMessage();
                    } else {
                        pinMessage(selectedMessage.id);
                    }
                    break;
                case 'delete':
                    deleteMessage(selectedMessage.id);
                    break;
                default:
                    if (action) toggleReaction(selectedMessage.id, action);
                    break;
            }
            closeAllModals();
        }

        async function sendMessage() {
            // –í –∫–∞–Ω–∞–ª–∞—Ö –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –∏ —Å–æ–∑–¥–∞—Ç–µ–ª—å
            if (isChannel && !isAdmin && !isCreator) {
                alert('–í –∫–∞–Ω–∞–ª–∞—Ö –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã');
                return;
            }
            
            if (!isGroupMember && (isGroupChat || isChannel || isBotChat)) {
                alert('–í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–º —ç—Ç–æ–≥–æ —á–∞—Ç–∞');
                return;
            }
            
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;
            
            try {
                const messageData = {
                    text: text,
                    sender: currentUserId,
                    timestamp: Date.now(),
                    type: 'text',
                    replyTo: replyingTo,
                    delivered: false
                };
                
                const encrypted = encryptData(messageData);
                const messageId = Date.now().toString();
                
                await database.ref(`messages/${currentChatId}/${messageId}`).set({
                    encryptedData: encrypted,
                    timestamp: Date.now()
                });
                
                setTimeout(async () => {
                    messageData.delivered = true;
                    const updatedEncrypted = encryptData(messageData);
                    await database.ref(`messages/${currentChatId}/${messageId}`).update({
                        encryptedData: updatedEncrypted
                    });
                }, 1000);
                
                await updateLastMessage(text);
                
                input.value = '';
                input.style.height = 'auto';
                document.getElementById('sendButton').disabled = true;
                cancelReply();
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–æ–º, –µ—Å–ª–∏ —ç—Ç–æ —á–∞—Ç —Å –±–æ—Ç–æ–º
                if (isBotChat && botInstance && botInstance.onMessage) {
                    await processBotMessage(text, messageId);
                }
                
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–æ–º
        async function processBotMessage(userMessage, messageId) {
            try {
                const context = {
                    userId: currentUserId,
                    userName: currentUser,
                    chatId: currentChatId,
                    messageId: messageId,
                    reply: async (response) => {
                        await sendBotResponse(response);
                    },
                    buttonPayload: null
                };
                
                await botInstance.onMessage({ text: userMessage }, context);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–æ–º:', error);
                await sendBotErrorMessage(`–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${error.message}`);
            }
        }

        async function handleImageUpload(event) {
            // –í –∫–∞–Ω–∞–ª–∞—Ö –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –∏ —Å–æ–∑–¥–∞—Ç–µ–ª—å
            if (isChannel && !isAdmin && !isCreator) {
                alert('–í –∫–∞–Ω–∞–ª–∞—Ö –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã');
                return;
            }
            
            if (!isGroupMember && (isGroupChat || isChannel || isBotChat)) {
                alert('–í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–º —ç—Ç–æ–≥–æ —á–∞—Ç–∞');
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const sendBtn = document.getElementById('sendButton');
                const originalHTML = sendBtn.innerHTML;
                sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                sendBtn.disabled = true;
                
                const dataUrl = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
                
                const apiKey = "02cf7a0dc37b8a8adaedc9784752a3db";
                const formData = new FormData();
                formData.append("image", dataUrl.split(",")[1]);
                formData.append("key", apiKey);

                const response = await fetch("https://api.imgbb.com/1/upload", {
                    method: "POST",
                    body: formData,
                });
                
                const data = await response.json();
                const imageUrl = data.data?.url;
                
                if (!imageUrl) throw new Error('–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å');
                
                const messageData = {
                    text: document.getElementById('messageInput').value.trim(),
                    image: imageUrl,
                    sender: currentUserId,
                    timestamp: Date.now(),
                    type: 'image',
                    delivered: false
                };
                
                const encrypted = encryptData(messageData);
                const messageId = Date.now().toString();
                
                await database.ref(`messages/${currentChatId}/${messageId}`).set({
                    encryptedData: encrypted,
                    timestamp: Date.now()
                });
                
                setTimeout(async () => {
                    messageData.delivered = true;
                    const updatedEncrypted = encryptData(messageData);
                    await database.ref(`messages/${currentChatId}/${messageId}`).update({
                        encryptedData: updatedEncrypted
                    });
                }, 1000);
                
                await updateLastMessage('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                
                document.getElementById('messageInput').value = '';
                document.getElementById('imageUpload').value = '';
                cancelReply();
                
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
            } finally {
                const sendBtn = document.getElementById('sendButton');
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                sendBtn.disabled = !document.getElementById('messageInput').value.trim();
            }
        }

        async function updateLastMessage(lastMessage) {
            if (!currentChatData) return;
            
            try {
                currentChatData.lastMessage = lastMessage;
                currentChatData.lastMessageTime = Date.now();
                
                const encryptedData = encryptData(currentChatData);
                
                await database.ref(`chats/${currentChatId}`).update({
                    encryptedData: encryptedData
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            }
        }

        function setReplyTo(message) {
            replyingTo = message.id;
            document.getElementById('replyContent').textContent = message.text || '–°–æ–æ–±—â–µ–Ω–∏–µ';
            document.getElementById('replyContainer').style.display = 'flex';
            document.getElementById('messageInput').focus();
        }

        function cancelReply() {
            replyingTo = null;
            document.getElementById('replyContainer').style.display = 'none';
        }

        async function toggleReaction(messageId, reaction) {
            if (!isGroupMember && (isGroupChat || isChannel || isBotChat)) {
                alert('–í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–º —ç—Ç–æ–≥–æ —á–∞—Ç–∞');
                return;
            }
            
            try {
                const message = allMessages.get(messageId);
                if (!message) return;
                
                if (!message.reactions) message.reactions = {};
                if (!message.reactions[reaction]) message.reactions[reaction] = [];
                
                const userIndex = message.reactions[reaction].indexOf(currentUserId);
                
                if (userIndex > -1) {
                    message.reactions[reaction].splice(userIndex, 1);
                    if (message.reactions[reaction].length === 0) {
                        delete message.reactions[reaction];
                    }
                } else {
                    message.reactions[reaction].push(currentUserId);
                }
                
                const encrypted = encryptData(message);
                await database.ref(`messages/${currentChatId}/${messageId}`).update({
                    encryptedData: encrypted
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ä–µ–∞–∫—Ü–∏–∏:', error);
            }
        }

        function handleMenuAction(action) {
            switch (action) {
                case 'mute':
                    toggleMute();
                    break;
                case 'clear':
                    clearHistory();
                    break;
                case 'leave':
                    leaveGroup();
                    break;
            }
            closeAllModals();
        }

        function toggleMute() {
            const muted = JSON.parse(localStorage.getItem('hamburger_muted_chats') || '[]');
            const isMuted = muted.includes(currentChatId);
            
            if (isMuted) {
                muted.splice(muted.indexOf(currentChatId), 1);
                showNotification('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã');
            } else {
                muted.push(currentChatId);
                showNotification('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã');
            }
            
            localStorage.setItem('hamburger_muted_chats', JSON.stringify(muted));
        }

        async function clearHistory() {
            if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞?')) return;
            
            try {
                await database.ref(`messages/${currentChatId}`).remove();
                document.getElementById('messagesContainer').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üí¨</div>
                        <h3>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
                        <p>–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –æ—á–∏—â–µ–Ω–∞</p>
                    </div>
                `;
                allMessages.clear();
                displayedMessageIds.clear();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∏—Å—Ç–æ—Ä–∏–∏');
            }
        }

        async function leaveGroup() {
            if (!isGroupChat && !isChannel && !isBotChat) return;
            
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?')) return;
            
            try {
                await database.ref(`userChats/${currentUserId}/${currentChatId}`).remove();
                
                if (currentChatData.participants && Array.isArray(currentChatData.participants)) {
                    const index = currentChatData.participants.indexOf(currentUserId);
                    if (index > -1) {
                        currentChatData.participants.splice(index, 1);
                        
                        showNotification(`${currentUser} –ø–æ–∫–∏–Ω—É–ª(–∞) —á–∞—Ç`);
                        
                        const encrypted = encryptData(currentChatData);
                        await database.ref(`chats/${currentChatId}`).update({ 
                            encryptedData: encrypted 
                        });
                    }
                }
                
                alert('–í—ã –≤—ã—à–ª–∏ –∏–∑ —á–∞—Ç–∞');
                window.location.href = 'https://hamburgerchat.github.io/main.html';
                
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ —á–∞—Ç–∞: ' + error.message);
            }
        }

        async function joinGroup() {
            try {
                if (!currentChatData.participants) {
                    currentChatData.participants = [];
                }
                
                if (Array.isArray(currentChatData.participants)) {
                    if (!currentChatData.participants.includes(currentUserId)) {
                        currentChatData.participants.push(currentUserId);
                    }
                } else {
                    currentChatData.participants[currentUserId] = true;
                }
                
                const encrypted = encryptData(currentChatData);
                await database.ref(`chats/${currentChatId}`).update({ 
                    encryptedData: encrypted 
                });
                
                await database.ref(`userChats/${currentUserId}/${currentChatId}`).set(true);
                
                showNotification(`${currentUser} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è(–∞—Å—å) –∫ —á–∞—Ç—É`);
                
                isGroupMember = true;
                document.getElementById('joinGroupContainer').style.display = 'none';
                
                if (isChannel) {
                    if (isAdmin || isCreator) {
                        document.getElementById('inputContainer').style.display = 'flex';
                        document.getElementById('channelInputContainer').style.display = 'none';
                    } else {
                        document.getElementById('inputContainer').style.display = 'none';
                        document.getElementById('channelInputContainer').style.display = 'flex';
                    }
                    updateSubscribeButton();
                } else {
                    document.getElementById('inputContainer').style.display = 'flex';
                    document.getElementById('channelInputContainer').style.display = 'none';
                }
                
                // –î–ª—è –±–æ—Ç–æ–≤ –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥ –±–æ—Ç–∞
                if (isBotChat && currentChatData.botScriptUrl) {
                    await loadBotScript(currentChatData.botScriptUrl);
                }
                
                await loadMessages();
                await loadPinnedMessage();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ —á–∞—Ç—É:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ –∫ —á–∞—Ç—É: ' + error.message);
            }
        }

        async function deleteMessage(messageId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) return;
            
            try {
                await database.ref(`messages/${currentChatId}/${messageId}`).remove();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
            }
        }

        function openImage(url) {
            window.open(url, '_blank');
        }

        function scrollToMessage(messageId) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                messageElement.style.backgroundColor = 'var(--service-bg)';
                setTimeout(() => {
                    messageElement.style.backgroundColor = '';
                }, 2000);
            }
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('ru-RU', { 
                hour: '2-digit', minute: '2-digit' 
            });
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        function closeStickerView() {
            document.getElementById('stickerView').style.display = 'none';
        }

        function closeAllModals() {
            document.getElementById('chatMenu').style.display = 'none';
            document.getElementById('messageContextMenu').style.display = 'none';
            document.getElementById('stickerPanel').style.display = 'none';
            document.getElementById('stickerView').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }
        
        function showNotification(text) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = text;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
    </script>
</body>
</html>
