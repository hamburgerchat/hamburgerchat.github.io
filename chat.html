<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hamburger ‚Äî –ß–∞—Ç</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <style>
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --bg-tertiary: #f1f3f4;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --text-tertiary: #9ca3af;
      --border-color: #e5e7eb;
      --accent-color: #ff7f50;
      --accent-gradient: linear-gradient(135deg, #ff7f50, #ffcc70);
      --chat-bg: #f0f2f5;
      --shadow: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-light: 0 1px 2px rgba(0,0,0,0.05);
      --card-bg: #ffffff;
      --hover-bg: #f3f4f6;
      --danger-color: #ef4444;
      --success-color: #10b981;
      --message-bg: #ffffff;
      --own-message-bg: #e3f2fd;
      --role-creator: #ff6b35;
      --role-admin: #4ecdc4;
      --role-member: #94a3b8;
      --online-color: #10b981;
      --typing-color: #f59e0b;
      --reply-bg: #f8f9fa;
      --service-bg: rgba(255, 127, 80, 0.1);
      --service-text: #ff7f50;
      --read-color: #2563eb;
      --notification-bg: rgba(0, 0, 0, 0.7);
      --notification-text: #ffffff;
      --link-color: #2563eb;
      --call-color: #10b981;
    }

    [data-theme="dark"] {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-tertiary: #94a3b8;
      --border-color: #334155;
      --card-bg: #1e293b;
      --hover-bg: #334155;
      --chat-bg: #0f172a;
      --shadow: 0 1px 3px rgba(0,0,0,0.3);
      --shadow-light: 0 1px 2px rgba(0,0,0,0.2);
      --message-bg: #1e293b;
      --own-message-bg: #1e3a5f;
      --role-creator: #fdba74;
      --role-admin: #5eead4;
      --role-member: #64748b;
      --reply-bg: #334155;
      --service-bg: rgba(253, 186, 116, 0.15);
      --service-text: #fdba74;
      --read-color: #60a5fa;
      --notification-bg: rgba(255, 255, 255, 0.9);
      --notification-text: #1e293b;
      --link-color: #60a5fa;
      --call-color: #34d399;
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
      font-family: 'Inter', sans-serif; 
    }
    
    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: var(--chat-bg);
      position: relative;
    }
    
    .chat-header {
      background: var(--bg-primary);
      padding: 0.7rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 100;
      min-height: 60px;
      backdrop-filter: blur(10px);
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      flex: 1;
    }
    
    .back-button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .back-button:hover {
      background: var(--hover-bg);
      transform: translateX(-2px);
    }
    
    .chat-info {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      cursor: pointer;
    }
    
    .chat-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--accent-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: white;
      font-size: 1.1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .chat-avatar.has-image {
      background-size: cover;
      background-position: center;
    }
    
    .chat-details {
      display: flex;
      flex-direction: column;
    }
    
    .chat-name {
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-primary);
    }
    
    .chat-status {
      font-size: 0.75rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    
    .online-indicator {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--online-color);
    }
    
    .header-actions {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }
    
    .call-button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--call-color);
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .call-button:hover {
      background: var(--hover-bg);
      transform: scale(1.1);
    }
    
    .call-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .menu-toggle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .menu-toggle:hover {
      background: var(--hover-bg);
    }
    
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      scroll-behavior: smooth;
      padding-bottom: 100px;
    }
    
    .message {
      display: flex;
      max-width: 75%;
      position: relative;
      animation: messageAppear 0.3s ease;
    }
    
    @keyframes messageAppear {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .message.own {
      align-self: flex-end;
      margin-left: auto;
    }
    
    .message.group:not(.own) {
      padding-left: 36px;
    }
    
    .message-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--accent-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: white;
      font-size: 0.7rem;
      position: absolute;
      left: 0;
      bottom: 2px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .message-content {
      background: var(--message-bg);
      border-radius: 16px;
      padding: 0.6rem 0.9rem;
      box-shadow: var(--shadow-light);
      position: relative;
      min-width: 50px;
      border: 1px solid rgba(0,0,0,0.05);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .message-content:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .message.own .message-content {
      background: var(--own-message-bg);
      border-bottom-right-radius: 6px;
    }
    
    .message:not(.own) .message-content {
      border-bottom-left-radius: 6px;
    }
    
    .message-header {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      margin-bottom: 0.2rem;
    }
    
    .sender-name {
      font-weight: 600;
      font-size: 0.75rem;
      color: var(--text-primary);
      cursor: pointer;
    }
    
    .message-role {
      font-size: 0.6rem;
      font-weight: 600;
      padding: 0.1rem 0.3rem;
      border-radius: 6px;
      background: var(--role-member);
      color: white;
    }
    
    .role-creator {
      background: var(--role-creator);
    }
    
    .role-admin {
      background: var(--role-admin);
    }
    
    .message-text {
      font-size: 0.82rem;
      line-height: 1.4;
      color: var(--text-primary);
      word-wrap: break-word;
    }
    
    .message-text a {
      color: var(--link-color);
      text-decoration: underline;
    }
    
    .message-image {
      max-width: 200px;
      max-height: 200px;
      border-radius: 10px;
      margin-top: 0.3rem;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .message-sticker {
      font-size: 2.2rem;
      text-align: center;
      padding: 0.4rem;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    
    .message-sticker:hover {
      transform: scale(1.1);
    }
    
    .message-time {
      font-size: 0.65rem;
      color: var(--text-tertiary);
      text-align: right;
      margin-top: 0.2rem;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.2rem;
    }
    
    .message.own .message-time {
      text-align: left;
      justify-content: flex-start;
    }
    
    .message-status {
      display: flex;
      gap: 0.1rem;
    }
    
    .status-icon {
      font-size: 0.55rem;
      color: var(--text-tertiary);
    }
    
    .status-icon.read {
      color: var(--read-color);
    }
    
    .reactions {
      display: flex;
      gap: 0.2rem;
      margin-top: 0.2rem;
      flex-wrap: wrap;
    }
    
    .reaction {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 0.1rem 0.3rem;
      font-size: 0.65rem;
      display: flex;
      align-items: center;
      gap: 0.1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .reaction:hover {
      transform: scale(1.1);
      background: var(--hover-bg);
    }
    
    .reaction.user-reaction {
      background: rgba(255, 127, 80, 0.1);
      border-color: var(--accent-color);
    }
    
    .reaction-count {
      font-size: 0.55rem;
      color: var(--text-secondary);
    }
    
    .reaction-users {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 0.4rem;
      font-size: 0.65rem;
      white-space: nowrap;
      z-index: 10;
      box-shadow: var(--shadow);
      display: none;
    }
    
    .reaction:hover .reaction-users {
      display: block;
    }
    
    .reply-preview {
      background: var(--reply-bg);
      border-left: 3px solid var(--accent-color);
      padding: 0.3rem 0.5rem;
      border-radius: 5px;
      margin-bottom: 0.3rem;
      font-size: 0.75rem;
      cursor: pointer;
    }
    
    .reply-sender {
      font-weight: 600;
      color: var(--accent-color);
      margin-bottom: 0.1rem;
      font-size: 0.7rem;
    }
    
    .reply-text {
      color: var(--text-secondary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 0.7rem;
    }
    
    .reply-container {
      background: var(--bg-primary);
      padding: 0.5rem 0.9rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .reply-info {
      flex: 1;
    }
    
    .reply-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 0.1rem;
    }
    
    .reply-content {
      font-size: 0.85rem;
      color: var(--text-primary);
    }
    
    .cancel-reply {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.9rem;
      padding: 0.2rem;
      border-radius: 50%;
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .cancel-reply:hover {
      background: var(--hover-bg);
    }
    
    .input-container {
      background: var(--bg-primary);
      padding: 0.7rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      align-items: flex-end;
      gap: 0.5rem;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 90;
      backdrop-filter: blur(10px);
    }
    
    .attachment-btn, .sticker-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    
    .attachment-btn:hover, .sticker-btn:hover {
      background: var(--hover-bg);
      color: var(--accent-color);
    }
    
    .message-input-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .message-input {
      width: 100%;
      min-height: 36px;
      max-height: 100px;
      padding: 0.5rem 0.7rem;
      border: 1px solid var(--border-color);
      border-radius: 18px;
      font-size: 0.85rem;
      resize: none;
      outline: none;
      background: var(--bg-secondary);
      color: var(--text-primary);
      transition: border 0.2s ease;
      line-height: 1.4;
    }
    
    .message-input:focus {
      border-color: var(--accent-color);
    }
    
    .send-button {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: var(--accent-color);
      color: white;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
      box-shadow: 0 2px 4px rgba(255, 127, 80, 0.3);
    }
    
    .send-button:hover:not(:disabled) {
      background: #ff6b35;
      transform: scale(1.05);
    }
    
    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .service-message {
      text-align: center;
      margin: 0.6rem 0;
      padding: 0.3rem 0.9rem;
      align-self: center;
      max-width: 80%;
    }
    
    .service-content {
      background: var(--service-bg);
      color: var(--service-text);
      padding: 0.3rem 1rem;
      border-radius: 14px;
      font-size: 0.75rem;
      font-weight: 500;
      display: inline-block;
      border: 1px solid var(--service-bg);
    }
    
    .call-message {
      background: var(--service-bg);
      border: 1px solid var(--call-color);
      border-radius: 16px;
      padding: 0.9rem;
      text-align: center;
      max-width: 280px;
      margin: 0.4rem auto;
    }
    
    .call-message-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.6rem;
    }
    
    .call-icon {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: var(--call-color);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.3rem;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .call-title {
      font-weight: 600;
      color: var(--call-color);
      font-size: 0.9rem;
    }
    
    .call-description {
      color: var(--text-secondary);
      font-size: 0.8rem;
    }
    
    .call-buttons {
      display: flex;
      gap: 0.6rem;
      margin-top: 0.4rem;
    }
    
    .call-accept-btn {
      padding: 0.5rem 1rem;
      background: var(--call-color);
      color: white;
      border: none;
      border-radius: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.8rem;
    }
    
    .call-accept-btn:hover {
      background: #0da271;
      transform: translateY(-2px);
    }
    
    .call-decline-btn {
      padding: 0.5rem 1rem;
      background: var(--danger-color);
      color: white;
      border: none;
      border-radius: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.8rem;
    }
    
    .call-decline-btn:hover {
      background: #dc2626;
      transform: translateY(-2px);
    }
    
    .chat-menu {
      display: none;
      position: fixed;
      top: 60px;
      right: 1rem;
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: var(--shadow);
      z-index: 1000;
      animation: fadeIn 0.2s ease;
      min-width: 180px;
      border: 1px solid var(--border-color);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .menu-item {
      padding: 0.9rem 1rem;
      cursor: pointer;
      transition: background 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.7rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .menu-item:last-child {
      border-bottom: none;
    }
    
    .menu-item:hover {
      background: var(--hover-bg);
    }
    
    .menu-icon {
      width: 14px;
      text-align: center;
      color: var(--text-secondary);
    }
    
    .menu-text {
      font-size: 0.85rem;
      color: var(--text-primary);
    }
    
    .menu-danger {
      color: var(--danger-color);
    }
    
    .menu-danger .menu-icon {
      color: var(--danger-color);
    }
    
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.3);
      z-index: 999;
    }
    
    .message-context-menu {
      display: none;
      position: fixed;
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: var(--shadow);
      z-index: 1001;
      animation: fadeIn 0.2s ease;
      min-width: 160px;
      border: 1px solid var(--border-color);
    }
    
    .context-header {
      padding: 0.9rem;
      border-bottom: 1px solid var(--border-color);
      text-align: center;
      font-weight: 600;
      font-size: 0.85rem;
    }
    
    .reaction-buttons {
      display: flex;
      justify-content: space-between;
      padding: 0.7rem;
      border-bottom: 1px solid var(--border-color);
      overflow-x: auto;
      gap: 0.2rem;
    }
    
    .reaction-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s ease;
      font-size: 1rem;
      background: none;
      border: none;
      flex-shrink: 0;
    }
    
    .reaction-btn:hover {
      transform: scale(1.2);
      background: var(--hover-bg);
    }
    
    .context-item {
      padding: 0.7rem 0.9rem;
      cursor: pointer;
      transition: background 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.7rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .context-item:last-child {
      border-bottom: none;
    }
    
    .context-item:hover {
      background: var(--hover-bg);
    }
    
    .context-icon {
      width: 14px;
      text-align: center;
      color: var(--text-secondary);
    }
    
    .context-text {
      font-size: 0.8rem;
      color: var(--text-primary);
    }
    
    .context-danger {
      color: var(--danger-color);
    }
    
    .context-danger .context-icon {
      color: var(--danger-color);
    }
    
    .sticker-panel {
      display: none;
      position: fixed;
      bottom: 70px;
      left: 1rem;
      right: 1rem;
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: var(--shadow);
      padding: 0.9rem;
      z-index: 1000;
      max-height: 280px;
      border: 1px solid var(--border-color);
      flex-direction: column;
    }
    
    .sticker-search {
      margin-bottom: 0.9rem;
    }
    
    .sticker-search input {
      width: 100%;
      padding: 0.7rem 0.9rem;
      border: 1px solid var(--border-color);
      border-radius: 0.7rem;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 0.9rem;
    }
    
    .sticker-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 0.9rem;
    }
    
    .sticker-tab {
      flex: 1;
      padding: 0.7rem;
      text-align: center;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-secondary);
      border-bottom: 2px solid transparent;
      font-size: 0.8rem;
    }
    
    .sticker-tab.active {
      color: var(--accent-color);
      border-bottom-color: var(--accent-color);
    }
    
    .sticker-packs {
      flex: 1;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 0.7rem;
    }
    
    .sticker-pack {
      background: var(--bg-secondary);
      border-radius: 0.7rem;
      padding: 0.9rem;
      cursor: pointer;
      text-align: center;
      transition: background 0.2s ease;
    }
    
    .sticker-pack:hover {
      background: var(--hover-bg);
    }
    
    .sticker-pack img {
      width: 45px;
      height: 45px;
      object-fit: contain;
      margin-bottom: 0.4rem;
    }
    
    .sticker-pack-name {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--text-primary);
    }
    
    .sticker-view {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1100;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    
    .sticker-view-content {
      background: var(--bg-primary);
      border-radius: 0.9rem;
      padding: 1.3rem;
      max-width: 90%;
      max-height: 80%;
      overflow-y: auto;
    }
    
    .sticker-view-stickers {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
      gap: 0.7rem;
      margin-bottom: 0.9rem;
    }
    
    .sticker-view-sticker {
      cursor: pointer;
      border-radius: 0.4rem;
      transition: transform 0.2s ease;
    }
    
    .sticker-view-sticker:hover {
      transform: scale(1.1);
    }
    
    .sticker-view-sticker img {
      width: 100%;
      height: auto;
    }
    
    .sticker-view-actions {
      display: flex;
      gap: 0.9rem;
      justify-content: center;
    }
    
    .close-sticker-view {
      background: var(--danger-color);
      color: white;
      border: none;
      padding: 0.7rem 1.3rem;
      border-radius: 0.7rem;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.8rem;
    }
    
    .add-sticker-pack {
      background: var(--success-color);
      color: white;
      border: none;
      padding: 0.7rem 1.3rem;
      border-radius: 0.7rem;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.8rem;
    }
    
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 1.8rem;
      color: var(--text-secondary);
    }
    
    .loading-spinner {
      width: 36px;
      height: 36px;
      border: 3px solid var(--border-color);
      border-top: 3px solid var(--accent-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 0.9rem;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .pinned-message {
      border-left: 3px solid var(--accent-color);
    }

    .pinned-message-top {
      background: var(--bg-secondary);
      border-left: 3px solid var(--accent-color);
      padding: 0.7rem;
      margin: 0 0.9rem 0.4rem 0.9rem;
      border-radius: 0.4rem;
      cursor: pointer;
      display: none;
    }
    
    .pinned-message-content {
      font-size: 0.85rem;
      color: var(--text-primary);
    }
    
    .pinned-message-info {
      font-size: 0.65rem;
      color: var(--text-secondary);
      margin-top: 0.2rem;
    }
    
    .unpin-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      float: right;
      padding: 0.1rem 0.4rem;
      font-size: 0.7rem;
    }

    .scroll-to-bottom {
      position: fixed;
      bottom: 80px;
      right: 15px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent-color);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 80;
      transition: all 0.3s ease;
      opacity: 0;
      pointer-events: none;
      font-size: 0.9rem;
    }
    
    .scroll-to-bottom.visible {
      opacity: 1;
      pointer-events: all;
    }
    
    .scroll-to-bottom:hover {
      transform: translateY(-2px);
    }
    
    .notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--notification-bg);
      color: var(--notification-text);
      padding: 0.7rem 1.3rem;
      border-radius: 0.9rem;
      font-size: 0.85rem;
      font-weight: 500;
      z-index: 2000;
      text-align: center;
      max-width: 80%;
      animation: notificationAppear 0.3s ease, notificationDisappear 0.3s ease 2.7s;
      pointer-events: none;
    }
    
    @keyframes notificationAppear {
      from { opacity: 0; transform: translate(-50%, -40%); }
      to { opacity: 1; transform: translate(-50%, -50%); }
    }
    
    @keyframes notificationDisappear {
      from { opacity: 1; transform: translate(-50%, -50%); }
      to { opacity: 0; transform: translate(-50%, -60%); }
    }
    
    .join-group-container {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-primary);
      z-index: 200;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1.8rem;
      text-align: center;
    }
    
    .join-group-icon {
      width: 70px;
      height: 70px;
      background: var(--accent-gradient);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1.3rem;
    }
    
    .join-group-icon i {
      color: white;
      font-size: 1.8rem;
    }
    
    .join-group-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 0.7rem;
      color: var(--text-primary);
    }
    
    .join-group-description {
      color: var(--text-secondary);
      margin-bottom: 1.8rem;
      max-width: 350px;
      line-height: 1.5;
      font-size: 0.9rem;
    }
    
    .join-group-btn {
      padding: 0.7rem 1.8rem;
      background: var(--accent-color);
      color: white;
      border: none;
      border-radius: 0.7rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }
    
    .join-group-btn:hover {
      background: #ff6b35;
      transform: translateY(-2px);
    }
    
    .typing-indicator {
      display: none;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 0.9rem;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    
    .typing-dots {
      display: flex;
      gap: 0.2rem;
    }
    
    .typing-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--text-secondary);
      animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }
    
    .profile-view {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-primary);
      z-index: 200;
      flex-direction: column;
      overflow-y: auto;
    }
    
    .profile-header {
      background: var(--accent-gradient);
      padding: 1.8rem 1.3rem 1.3rem;
      color: white;
      position: relative;
    }
    
    .profile-back-btn {
      position: absolute;
      top: 1.3rem;
      left: 1.3rem;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      backdrop-filter: blur(10px);
    }
    
    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: 600;
      margin: 0 auto 1.3rem;
      backdrop-filter: blur(10px);
      border: 3px solid rgba(255,255,255,0.3);
    }
    
    .profile-avatar.has-image {
      background-size: cover;
      background-position: center;
    }
    
    .profile-name {
      text-align: center;
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 0.4rem;
    }
    
    .profile-status {
      text-align: center;
      font-size: 0.9rem;
      opacity: 0.9;
      margin-bottom: 1.3rem;
    }
    
    .profile-actions {
      display: flex;
      justify-content: center;
      gap: 0.9rem;
    }
    
    .profile-action-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 0.7rem 1.3rem;
      border-radius: 0.7rem;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      backdrop-filter: blur(10px);
    }
    
    .profile-content {
      padding: 1.3rem;
    }
    
    .profile-section {
      background: var(--card-bg);
      border-radius: 0.7rem;
      padding: 1.3rem;
      margin-bottom: 1.3rem;
      box-shadow: var(--shadow-light);
    }
    
    .profile-section-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.9rem;
      color: var(--text-primary);
    }
    
    .profile-info-item {
      display: flex;
      justify-content: space-between;
      padding: 0.7rem 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .profile-info-item:last-child {
      border-bottom: none;
    }
    
    .profile-info-label {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }
    
    .profile-info-value {
      color: var(--text-primary);
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    .profile-media-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.4rem;
    }
    
    .profile-media-item {
      aspect-ratio: 1;
      border-radius: 0.4rem;
      background: var(--bg-secondary);
      cursor: pointer;
      overflow: hidden;
    }
    
    .profile-media-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .profile-media-count {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    
    .call-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-primary);
      z-index: 300;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    
    .call-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: var(--accent-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      font-weight: 600;
      color: white;
      margin-bottom: 1.8rem;
    }
    
    .call-avatar.has-image {
      background-size: cover;
      background-position: center;
    }
    
    .call-name {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.4rem;
      color: var(--text-primary);
    }
    
    .call-status {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 2.5rem;
    }
    
    .call-timer {
      font-size: 1.8rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2.5rem;
    }
    
    .call-controls {
      display: flex;
      gap: 1.3rem;
    }
    
    .call-control-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .call-end-btn {
      background: var(--danger-color);
      color: white;
    }
    
    .call-mute-btn, .call-video-btn {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }
    
    .call-mute-btn.active, .call-video-btn.active {
      background: var(--accent-color);
      color: white;
    }
    
    .call-control-btn:hover {
      transform: translateY(-2px);
    }
    
    .call-end-btn:hover {
      background: #dc2626;
    }
    
    .call-mute-btn:hover:not(.active), .call-video-btn:hover:not(.active) {
      background: var(--hover-bg);
    }
    
    .incoming-call {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-primary);
      z-index: 400;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      animation: fadeIn 0.3s ease;
    }
    
    .incoming-call-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: var(--accent-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      font-weight: 600;
      color: white;
      margin-bottom: 1.8rem;
    }
    
    .incoming-call-avatar.has-image {
      background-size: cover;
      background-position: center;
    }
    
    .incoming-call-name {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.4rem;
      color: var(--text-primary);
    }
    
    .incoming-call-type {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 2.5rem;
    }
    
    .incoming-call-controls {
      display: flex;
      gap: 2.5rem;
    }
    
    .incoming-call-accept {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--call-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .incoming-call-decline {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--danger-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .incoming-call-accept:hover {
      background: #0da271;
      transform: translateY(-2px);
    }
    
    .incoming-call-decline:hover {
      background: #dc2626;
      transform: translateY(-2px);
    }
    
    .no-messages {
      text-align: center;
      color: var(--text-secondary);
      padding: 2.5rem 1.3rem;
      font-size: 0.9rem;
    }
    
    .spam-warning {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--danger-color);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 0.7rem;
      font-size: 0.9rem;
      font-weight: 500;
      z-index: 2000;
      text-align: center;
      max-width: 80%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      animation: fadeIn 0.3s ease;
    }
    
    @media (max-width: 768px) {
      .message {
        max-width: 85%;
      }
      
      .message-content {
        padding: 0.5rem 0.7rem;
      }
      
      .message-text {
        font-size: 0.8rem;
      }
      
      .message-image {
        max-width: 180px;
        max-height: 180px;
      }
      
      .input-container {
        padding: 0.5rem;
      }
      
      .chat-header {
        padding: 0.5rem 0.8rem;
        min-height: 55px;
      }
      
      .chat-avatar {
        width: 40px;
        height: 40px;
        font-size: 1rem;
      }
      
      .back-button, .call-button, .menu-toggle {
        width: 36px;
        height: 36px;
        font-size: 1rem;
      }
      
      .messages-container {
        padding: 0.8rem 0.5rem;
        padding-bottom: 90px;
      }
      
      .message-avatar {
        width: 24px;
        height: 24px;
        font-size: 0.6rem;
      }
      
      .message.group:not(.own) {
        padding-left: 32px;
      }
      
      .sticker-panel {
        bottom: 60px;
        left: 0.5rem;
        right: 0.5rem;
        max-height: 250px;
      }
      
      .scroll-to-bottom {
        bottom: 70px;
        right: 10px;
        width: 36px;
        height: 36px;
        font-size: 0.8rem;
      }
      
      .call-control-btn, .incoming-call-accept, .incoming-call-decline {
        width: 55px;
        height: 55px;
        font-size: 1.2rem;
      }
      
      .call-avatar, .incoming-call-avatar {
        width: 100px;
        height: 100px;
        font-size: 2rem;
      }
      
      .call-name, .incoming-call-name {
        font-size: 1.3rem;
      }
      
      .call-timer {
        font-size: 1.5rem;
      }
    }
    
    @media (max-width: 480px) {
      .message {
        max-width: 90%;
      }
      
      .message-content {
        padding: 0.4rem 0.6rem;
      }
      
      .message-text {
        font-size: 0.78rem;
      }
      
      .message-image {
        max-width: 160px;
        max-height: 160px;
      }
      
      .input-container {
        padding: 0.4rem;
      }
      
      .chat-header {
        padding: 0.4rem 0.6rem;
        min-height: 50px;
      }
      
      .chat-avatar {
        width: 36px;
        height: 36px;
        font-size: 0.9rem;
      }
      
      .back-button, .call-button, .menu-toggle {
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
      }
      
      .messages-container {
        padding: 0.6rem 0.4rem;
        padding-bottom: 80px;
      }
      
      .message-avatar {
        width: 22px;
        height: 22px;
        font-size: 0.55rem;
      }
      
      .message.group:not(.own) {
        padding-left: 28px;
      }
      
      .sticker-panel {
        bottom: 50px;
        left: 0.4rem;
        right: 0.4rem;
        max-height: 220px;
      }
      
      .scroll-to-bottom {
        bottom: 60px;
        right: 8px;
        width: 32px;
        height: 32px;
        font-size: 0.7rem;
      }
      
      .call-control-btn, .incoming-call-accept, .incoming-call-decline {
        width: 50px;
        height: 50px;
        font-size: 1.1rem;
      }
      
      .call-avatar, .incoming-call-avatar {
        width: 90px;
        height: 90px;
        font-size: 1.8rem;
      }
      
      .call-name, .incoming-call-name {
        font-size: 1.2rem;
      }
      
      .call-timer {
        font-size: 1.3rem;
      }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <div class="header-left">
        <button class="back-button" id="backButton">
          <i class="fas fa-arrow-left"></i>
        </button>
        <div class="chat-info" id="chatInfo">
          <div class="chat-avatar" id="chatAvatar">H</div>
          <div class="chat-details">
            <div class="chat-name" id="chatName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="chat-status" id="chatStatus">
              <span id="statusText">–∑–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button class="call-button" id="callButton">
          <i class="fas fa-phone-alt"></i>
        </button>
        <button class="menu-toggle" id="menuToggle">
          <i class="fas fa-ellipsis-v"></i>
        </button>
      </div>
    </div>
    
    <div class="pinned-message-top" id="pinnedMessageTop">
      <div class="pinned-message-content" id="pinnedMessageContent"></div>
      <div class="pinned-message-info" id="pinnedMessageInfo"></div>
      <button class="unpin-btn" id="unpinButton">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="messages-container" id="messagesContainer">
      <div class="loading-container">
        <div class="loading-spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
      </div>
    </div>
    
    <div class="typing-indicator" id="typingIndicator">
      <div class="typing-dots">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
      <span id="typingText">–ø–µ—á–∞—Ç–∞–µ—Ç...</span>
    </div>
    
    <div class="reply-container" id="replyContainer" style="display: none;">
      <div class="reply-info">
        <div class="reply-label">–û—Ç–≤–µ—Ç–∏—Ç—å</div>
        <div class="reply-content" id="replyContent"></div>
      </div>
      <button class="cancel-reply" id="cancelReply">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="input-container">
      <button class="attachment-btn" id="attachmentBtn">
        <i class="fas fa-paperclip"></i>
      </button>
      <button class="sticker-btn" id="stickerBtn">
        <i class="fas fa-smile"></i>
      </button>
      <div class="message-input-wrapper">
        <textarea class="message-input" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
      </div>
      <button class="send-button" id="sendButton" disabled>
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
    
    <button class="scroll-to-bottom" id="scrollToBottom">
      <i class="fas fa-chevron-down"></i>
    </button>
    
    <div class="chat-menu" id="chatMenu">
      <div class="menu-item" id="viewProfileMenuItem">
        <div class="menu-icon"><i class="fas fa-user"></i></div>
        <div class="menu-text">–ü—Ä–æ—Ñ–∏–ª—å</div>
      </div>
      <div class="menu-item" id="searchMenuItem">
        <div class="menu-icon"><i class="fas fa-search"></i></div>
        <div class="menu-text">–ü–æ–∏—Å–∫</div>
      </div>
      <div class="menu-item" id="mediaMenuItem">
        <div class="menu-icon"><i class="fas fa-photo-video"></i></div>
        <div class="menu-text">–ú–µ–¥–∏–∞—Ñ–∞–π–ª—ã</div>
      </div>
      <div class="menu-item" id="notificationsMenuItem">
        <div class="menu-icon"><i class="fas fa-bell"></i></div>
        <div class="menu-text">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
      </div>
      <div class="menu-item menu-danger" id="clearChatMenuItem">
        <div class="menu-icon"><i class="fas fa-trash"></i></div>
        <div class="menu-text">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</div>
      </div>
    </div>
    
    <div class="overlay" id="overlay"></div>
    
    <div class="message-context-menu" id="messageContextMenu">
      <div class="context-header" id="contextHeader">–°–æ–æ–±—â–µ–Ω–∏–µ</div>
      <div class="reaction-buttons">
        <button class="reaction-btn">üëç</button>
        <button class="reaction-btn">‚ù§Ô∏è</button>
        <button class="reaction-btn">üòÇ</button>
        <button class="reaction-btn">üòÆ</button>
      </div>
      <div class="context-item" id="replyContextItem">
        <div class="context-icon"><i class="fas fa-reply"></i></div>
        <div class="context-text">–û—Ç–≤–µ—Ç–∏—Ç—å</div>
      </div>
      <div class="context-item" id="copyContextItem">
        <div class="context-icon"><i class="fas fa-copy"></i></div>
        <div class="context-text">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
      </div>
      <div class="context-item" id="pinContextItem">
        <div class="context-icon"><i class="fas fa-thumbtack"></i></div>
        <div class="context-text">–ó–∞–∫—Ä–µ–ø–∏—Ç—å</div>
      </div>
      <div class="context-item" id="forwardContextItem">
        <div class="context-icon"><i class="fas fa-share"></i></div>
        <div class="context-text">–ü–µ—Ä–µ—Å–ª–∞—Ç—å</div>
      </div>
      <div class="context-item context-danger" id="deleteContextItem">
        <div class="context-icon"><i class="fas fa-trash"></i></div>
        <div class="context-text">–£–¥–∞–ª–∏—Ç—å</div>
      </div>
    </div>
    
    <div class="sticker-panel" id="stickerPanel">
      <div class="sticker-search">
        <input type="text" placeholder="–ü–æ–∏—Å–∫ —Å—Ç–∏–∫–µ—Ä–æ–≤..." id="stickerSearch">
      </div>
      <div class="sticker-tabs">
        <button class="sticker-tab active" data-tab="recent">–ù–µ–¥–∞–≤–Ω–∏–µ</button>
        <button class="sticker-tab" data-tab="favorites">–ò–∑–±—Ä–∞–Ω–Ω—ã–µ</button>
        <button class="sticker-tab" data-tab="packs">–ù–∞–±–æ—Ä—ã</button>
      </div>
      <div class="sticker-packs" id="stickerPacks">
        <!-- Stickers will be loaded here -->
      </div>
    </div>
    
    <div class="sticker-view" id="stickerView">
      <div class="sticker-view-content">
        <div class="sticker-view-stickers" id="stickerViewStickers">
          <!-- Stickers will be loaded here -->
        </div>
        <div class="sticker-view-actions">
          <button class="close-sticker-view" id="closeStickerView">–ó–∞–∫—Ä—ã—Ç—å</button>
          <button class="add-sticker-pack" id="addStickerPack">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞–±–æ—Ä</button>
        </div>
      </div>
    </div>
    
    <div class="profile-view" id="profileView">
      <div class="profile-header">
        <button class="profile-back-btn" id="profileBackBtn">
          <i class="fas fa-arrow-left"></i>
        </button>
        <div class="profile-avatar" id="profileAvatar">H</div>
        <div class="profile-name" id="profileName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
        <div class="profile-status" id="profileStatus">–±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ</div>
        <div class="profile-actions">
          <button class="profile-action-btn" id="profileMessageBtn">
            <i class="fas fa-comment"></i> –°–æ–æ–±—â–µ–Ω–∏–µ
          </button>
          <button class="profile-action-btn" id="profileCallBtn">
            <i class="fas fa-phone-alt"></i> –ó–≤–æ–Ω–æ–∫
          </button>
        </div>
      </div>
      <div class="profile-content">
        <div class="profile-section">
          <div class="profile-section-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
          <div class="profile-info-item">
            <div class="profile-info-label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
            <div class="profile-info-value" id="profilePhone">+7 (999) 123-45-67</div>
          </div>
          <div class="profile-info-item">
            <div class="profile-info-label">–ü–æ—á—Ç–∞</div>
            <div class="profile-info-value" id="profileEmail">user@example.com</div>
          </div>
          <div class="profile-info-item">
            <div class="profile-info-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>
            <div class="profile-info-value" id="profileRegDate">1 —è–Ω–≤–∞—Ä—è 2023</div>
          </div>
        </div>
        <div class="profile-section">
          <div class="profile-section-title">–ú–µ–¥–∏–∞—Ñ–∞–π–ª—ã</div>
          <div class="profile-media-grid" id="profileMediaGrid">
            <!-- Media items will be loaded here -->
          </div>
        </div>
      </div>
    </div>
    
    <div class="call-container" id="callContainer">
      <div class="call-avatar" id="callAvatar">H</div>
      <div class="call-name" id="callName">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
      <div class="call-status" id="callStatus">–ó–≤–æ–Ω–æ–∫...</div>
      <div class="call-timer" id="callTimer">00:00</div>
      <div class="call-controls">
        <button class="call-control-btn call-mute-btn" id="callMuteBtn">
          <i class="fas fa-microphone"></i>
        </button>
        <button class="call-control-btn call-video-btn" id="callVideoBtn">
          <i class="fas fa-video"></i>
        </button>
        <button class="call-control-btn call-end-btn" id="callEndBtn">
          <i class="fas fa-phone"></i>
        </button>
      </div>
    </div>
    
    <div class="incoming-call" id="incomingCall">
      <div class="incoming-call-avatar" id="incomingCallAvatar">H</div>
      <div class="incoming-call-name" id="incomingCallName">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
      <div class="incoming-call-type" id="incomingCallType">–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</div>
      <div class="incoming-call-controls">
        <button class="incoming-call-decline" id="incomingCallDecline">
          <i class="fas fa-phone"></i>
        </button>
        <button class="incoming-call-accept" id="incomingCallAccept">
          <i class="fas fa-phone"></i>
        </button>
      </div>
    </div>
    
    <div class="join-group-container" id="joinGroupContainer">
      <div class="join-group-icon">
        <i class="fas fa-users"></i>
      </div>
      <div class="join-group-title">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –≥—Ä—É–ø–ø–µ</div>
      <div class="join-group-description">–í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–º —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã. –•–æ—Ç–∏—Ç–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –æ–±—Å—É–∂–¥–µ–Ω–∏—è—Ö?</div>
      <button class="join-group-btn" id="joinGroupBtn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
    </div>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC4mOkOjf4wEBJc8Vv9Q5O5Q5w5w5w5w5w5",
      authDomain: "hamburger-chat.firebaseapp.com",
      databaseURL: "https://hamburger-chat-default-rtdb.firebaseio.com",
      projectId: "hamburger-chat",
      storageBucket: "hamburger-chat.appspot.com",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:abcdef123456"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Global variables
    let currentUser = null;
    let currentChat = null;
    let messages = [];
    let chatUsers = {};
    let replyingTo = null;
    let typingTimeout = null;
    let lastMessageTime = 0;
    let spamCount = 0;
    let spamResetTime = 0;
    let callTimerInterval = null;
    let callStartTime = null;

    // DOM elements
    const backButton = document.getElementById('backButton');
    const chatInfo = document.getElementById('chatInfo');
    const chatAvatar = document.getElementById('chatAvatar');
    const chatName = document.getElementById('chatName');
    const chatStatus = document.getElementById('chatStatus');
    const statusText = document.getElementById('statusText');
    const callButton = document.getElementById('callButton');
    const menuToggle = document.getElementById('menuToggle');
    const messagesContainer = document.getElementById('messagesContainer');
    const typingIndicator = document.getElementById('typingIndicator');
    const typingText = document.getElementById('typingText');
    const replyContainer = document.getElementById('replyContainer');
    const replyContent = document.getElementById('replyContent');
    const cancelReply = document.getElementById('cancelReply');
    const attachmentBtn = document.getElementById('attachmentBtn');
    const stickerBtn = document.getElementById('stickerBtn');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const scrollToBottom = document.getElementById('scrollToBottom');
    const chatMenu = document.getElementById('chatMenu');
    const overlay = document.getElementById('overlay');
    const messageContextMenu = document.getElementById('messageContextMenu');
    const contextHeader = document.getElementById('contextHeader');
    const replyContextItem = document.getElementById('replyContextItem');
    const copyContextItem = document.getElementById('copyContextItem');
    const pinContextItem = document.getElementById('pinContextItem');
    const forwardContextItem = document.getElementById('forwardContextItem');
    const deleteContextItem = document.getElementById('deleteContextItem');
    const stickerPanel = document.getElementById('stickerPanel');
    const stickerSearch = document.getElementById('stickerSearch');
    const stickerPacks = document.getElementById('stickerPacks');
    const stickerView = document.getElementById('stickerView');
    const stickerViewStickers = document.getElementById('stickerViewStickers');
    const closeStickerView = document.getElementById('closeStickerView');
    const addStickerPack = document.getElementById('addStickerPack');
    const profileView = document.getElementById('profileView');
    const profileBackBtn = document.getElementById('profileBackBtn');
    const profileAvatar = document.getElementById('profileAvatar');
    const profileName = document.getElementById('profileName');
    const profileStatus = document.getElementById('profileStatus');
    const profileMessageBtn = document.getElementById('profileMessageBtn');
    const profileCallBtn = document.getElementById('profileCallBtn');
    const profilePhone = document.getElementById('profilePhone');
    const profileEmail = document.getElementById('profileEmail');
    const profileRegDate = document.getElementById('profileRegDate');
    const profileMediaGrid = document.getElementById('profileMediaGrid');
    const callContainer = document.getElementById('callContainer');
    const callAvatar = document.getElementById('callAvatar');
    const callName = document.getElementById('callName');
    const callStatus = document.getElementById('callStatus');
    const callTimer = document.getElementById('callTimer');
    const callMuteBtn = document.getElementById('callMuteBtn');
    const callVideoBtn = document.getElementById('callVideoBtn');
    const callEndBtn = document.getElementById('callEndBtn');
    const incomingCall = document.getElementById('incomingCall');
    const incomingCallAvatar = document.getElementById('incomingCallAvatar');
    const incomingCallName = document.getElementById('incomingCallName');
    const incomingCallType = document.getElementById('incomingCallType');
    const incomingCallDecline = document.getElementById('incomingCallDecline');
    const incomingCallAccept = document.getElementById('incomingCallAccept');
    const joinGroupContainer = document.getElementById('joinGroupContainer');
    const joinGroupBtn = document.getElementById('joinGroupBtn');
    const pinnedMessageTop = document.getElementById('pinnedMessageTop');
    const pinnedMessageContent = document.getElementById('pinnedMessageContent');
    const pinnedMessageInfo = document.getElementById('pinnedMessageInfo');
    const unpinButton = document.getElementById('unpinButton');
    const viewProfileMenuItem = document.getElementById('viewProfileMenuItem');

    // Initialize the chat
    document.addEventListener('DOMContentLoaded', function() {
      initializeChat();
      setupEventListeners();
      loadStickers();
    });

    // Initialize chat data
    function initializeChat() {
      // Get current user from localStorage (in a real app, this would come from authentication)
      currentUser = JSON.parse(localStorage.getItem('currentUser')) || {
        id: 'user1',
        name: '–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
        avatar: '',
        phone: '+7 (999) 123-45-67',
        email: 'user@example.com',
        regDate: '1 —è–Ω–≤–∞—Ä—è 2023'
      };

      // Get chat ID from URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const chatId = urlParams.get('id');
      
      if (!chatId) {
        showNotification('–û—à–∏–±–∫–∞: ID —á–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω', 'error');
        return;
      }

      // Load chat data
      loadChat(chatId);
      
      // Load messages
      loadMessages(chatId);
      
      // Set up real-time listeners
      setupRealtimeListeners(chatId);
    }

    // Set up event listeners
    function setupEventListeners() {
      // Navigation
      backButton.addEventListener('click', goBack);
      scrollToBottom.addEventListener('click', scrollToBottomMessages);
      
      // Message input
      messageInput.addEventListener('input', handleMessageInput);
      messageInput.addEventListener('keydown', handleMessageKeydown);
      sendButton.addEventListener('click', sendMessage);
      
      // Menu
      menuToggle.addEventListener('click', toggleChatMenu);
      overlay.addEventListener('click', closeAllMenus);
      
      // Reply
      cancelReply.addEventListener('click', cancelReplyMessage);
      
      // Context menu
      document.addEventListener('click', closeContextMenu);
      
      // Stickers
      stickerBtn.addEventListener('click', toggleStickerPanel);
      closeStickerView.addEventListener('click', closeStickerViewPanel);
      addStickerPack.addEventListener('click', addNewStickerPack);
      
      // Profile
      profileBackBtn.addEventListener('click', closeProfileView);
      profileMessageBtn.addEventListener('click', profileMessageAction);
      profileCallBtn.addEventListener('click', profileCallAction);
      
      // Calls
      callButton.addEventListener('click', startCall);
      callEndBtn.addEventListener('click', endCall);
      callMuteBtn.addEventListener('click', toggleMuteCall);
      callVideoBtn.addEventListener('click', toggleVideoCall);
      incomingCallAccept.addEventListener('click', acceptIncomingCall);
      incomingCallDecline.addEventListener('click', declineIncomingCall);
      
      // Group
      joinGroupBtn.addEventListener('click', joinGroup);
      
      // Pinned message
      unpinButton.addEventListener('click', unpinMessage);
      
      // View profile from menu
      viewProfileMenuItem.addEventListener('click', viewProfile);
      chatInfo.addEventListener('click', viewProfile);
      
      // Scroll events
      messagesContainer.addEventListener('scroll', handleScroll);
      
      // Window resize
      window.addEventListener('resize', adjustLayout);
    }

    // Load chat data
    function loadChat(chatId) {
      // In a real app, this would fetch from Firebase
      // For demo purposes, we'll use mock data
      const chats = JSON.parse(localStorage.getItem('chats')) || {};
      currentChat = chats[chatId];
      
      if (!currentChat) {
        // Create a demo chat if it doesn't exist
        currentChat = {
          id: chatId,
          name: '–î–µ–º–æ —á–∞—Ç',
          type: 'private',
          avatar: '',
          users: ['user1', 'user2'],
          created: Date.now(),
          creator: 'user1'
        };
        
        // Save to localStorage for demo
        chats[chatId] = currentChat;
        localStorage.setItem('chats', JSON.stringify(chats));
      }
      
      // Load chat users
      loadChatUsers(currentChat.users);
      
      // Update UI
      updateChatUI();
    }

    // Load chat users
    function loadChatUsers(userIds) {
      // In a real app, this would fetch from Firebase
      // For demo purposes, we'll use mock data
      const users = JSON.parse(localStorage.getItem('users')) || {};
      
      // Create demo users if they don't exist
      if (!users['user2']) {
        users['user2'] = {
          id: 'user2',
          name: '–î–µ–º–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
          avatar: '',
          phone: '+7 (999) 987-65-43',
          email: 'demo@example.com',
          regDate: '15 —Ñ–µ–≤—Ä–∞–ª—è 2023',
          status: 'online',
          lastSeen: Date.now()
        };
        localStorage.setItem('users', JSON.stringify(users));
      }
      
      chatUsers = users;
    }

    // Update chat UI
    function updateChatUI() {
      if (!currentChat) return;
      
      // Set chat name and avatar
      chatName.textContent = currentChat.name;
      
      if (currentChat.type === 'private') {
        // For private chats, show the other user's info
        const otherUserId = currentChat.users.find(id => id !== currentUser.id);
        const otherUser = chatUsers[otherUserId];
        
        if (otherUser) {
          chatName.textContent = otherUser.name;
          
          if (otherUser.avatar) {
            chatAvatar.style.backgroundImage = `url(${otherUser.avatar})`;
            chatAvatar.classList.add('has-image');
            chatAvatar.textContent = '';
          } else {
            chatAvatar.textContent = otherUser.name.charAt(0).toUpperCase();
            chatAvatar.classList.remove('has-image');
          }
          
          // Update status
          if (otherUser.status === 'online') {
            statusText.textContent = '–≤ —Å–µ—Ç–∏';
            if (!chatStatus.querySelector('.online-indicator')) {
              const onlineIndicator = document.createElement('div');
              onlineIndicator.className = 'online-indicator';
              chatStatus.insertBefore(onlineIndicator, statusText);
            }
          } else {
            statusText.textContent = formatLastSeen(otherUser.lastSeen);
            const onlineIndicator = chatStatus.querySelector('.online-indicator');
            if (onlineIndicator) {
              onlineIndicator.remove();
            }
          }
        }
      } else {
        // For group chats
        if (currentChat.avatar) {
          chatAvatar.style.backgroundImage = `url(${currentChat.avatar})`;
          chatAvatar.classList.add('has-image');
          chatAvatar.textContent = '';
        } else {
          chatAvatar.textContent = currentChat.name.charAt(0).toUpperCase();
          chatAvatar.classList.remove('has-image');
        }
        
        // Update status for group
        const onlineCount = Object.values(chatUsers).filter(user => 
          user.status === 'online' && user.id !== currentUser.id
        ).length;
        
        if (onlineCount > 0) {
          statusText.textContent = `${onlineCount} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ–Ω–ª–∞–π–Ω`;
        } else {
          statusText.textContent = `${currentChat.users.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;
        }
      }
      
      // Show/hide join group container
      if (currentChat.type === 'group' && !currentChat.users.includes(currentUser.id)) {
        joinGroupContainer.style.display = 'flex';
        messagesContainer.style.display = 'none';
      } else {
        joinGroupContainer.style.display = 'none';
        messagesContainer.style.display = 'flex';
      }
    }

    // Load messages
    function loadMessages(chatId) {
      // In a real app, this would fetch from Firebase
      // For demo purposes, we'll use mock data
      const allMessages = JSON.parse(localStorage.getItem('messages')) || {};
      messages = allMessages[chatId] || [];
      
      // Update UI
      renderMessages();
      
      // Scroll to bottom
      setTimeout(() => {
        scrollToBottomMessages();
      }, 100);
    }

    // Render messages
    function renderMessages() {
      messagesContainer.innerHTML = '';
      
      if (messages.length === 0) {
        const noMessages = document.createElement('div');
        noMessages.className = 'no-messages';
        noMessages.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!';
        messagesContainer.appendChild(noMessages);
        return;
      }
      
      messages.forEach(message => {
        const messageElement = createMessageElement(message);
        messagesContainer.appendChild(messageElement);
      });
      
      // Update pinned message if exists
      updatePinnedMessage();
    }

    // Create message element
    function createMessageElement(message) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message';
      messageDiv.dataset.id = message.id;
      
      if (message.senderId === currentUser.id) {
        messageDiv.classList.add('own');
      }
      
      if (currentChat.type === 'group' && message.senderId !== currentUser.id) {
        messageDiv.classList.add('group');
      }
      
      // Message avatar (for group chats)
      if (currentChat.type === 'group' && message.senderId !== currentUser.id) {
        const sender = chatUsers[message.senderId];
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'message-avatar';
        
        if (sender && sender.avatar) {
          avatarDiv.style.backgroundImage = `url(${sender.avatar})`;
          avatarDiv.classList.add('has-image');
        } else {
          avatarDiv.textContent = sender ? sender.name.charAt(0).toUpperCase() : '?';
        }
        
        avatarDiv.addEventListener('click', () => viewUserProfile(message.senderId));
        messageDiv.appendChild(avatarDiv);
      }
      
      // Message content
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      
      // Message header (for group chats)
      if (currentChat.type === 'group' && message.senderId !== currentUser.id) {
        const sender = chatUsers[message.senderId];
        if (sender) {
          const headerDiv = document.createElement('div');
          headerDiv.className = 'message-header';
          
          const nameSpan = document.createElement('span');
          nameSpan.className = 'sender-name';
          nameSpan.textContent = sender.name;
          nameSpan.addEventListener('click', () => viewUserProfile(message.senderId));
          
          headerDiv.appendChild(nameSpan);
          
          // Add role if applicable
          if (message.senderId === currentChat.creator) {
            const roleSpan = document.createElement('span');
            roleSpan.className = 'message-role role-creator';
            roleSpan.textContent = '—Å–æ–∑–¥–∞—Ç–µ–ª—å';
            headerDiv.appendChild(roleSpan);
          } else if (currentChat.admins && currentChat.admins.includes(message.senderId)) {
            const roleSpan = document.createElement('span');
            roleSpan.className = 'message-role role-admin';
            roleSpan.textContent = '–∞–¥–º–∏–Ω';
            headerDiv.appendChild(roleSpan);
          }
          
          contentDiv.appendChild(headerDiv);
        }
      }
      
      // Reply preview
      if (message.replyTo) {
        const replyPreview = document.createElement('div');
        replyPreview.className = 'reply-preview';
        
        const replySender = document.createElement('div');
        replySender.className = 'reply-sender';
        
        const repliedMessage = messages.find(m => m.id === message.replyTo);
        if (repliedMessage) {
          const sender = chatUsers[repliedMessage.senderId];
          replySender.textContent = sender ? sender.name : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
          
          const replyText = document.createElement('div');
          replyText.className = 'reply-text';
          
          if (repliedMessage.type === 'text') {
            replyText.textContent = repliedMessage.content;
          } else if (repliedMessage.type === 'image') {
            replyText.textContent = 'üì∑ –§–æ—Ç–æ';
          } else if (repliedMessage.type === 'sticker') {
            replyText.textContent = 'üé≠ –°—Ç–∏–∫–µ—Ä';
          } else if (repliedMessage.type === 'call') {
            replyText.textContent = 'üìû –ó–≤–æ–Ω–æ–∫';
          }
          
          replyPreview.appendChild(replySender);
          replyPreview.appendChild(replyText);
          
          // Add click event to scroll to replied message
          replyPreview.addEventListener('click', () => {
            const repliedElement = document.querySelector(`.message[data-id="${message.replyTo}"]`);
            if (repliedElement) {
              repliedElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
              // Highlight the message
              repliedElement.style.backgroundColor = 'rgba(255, 127, 80, 0.1)';
              setTimeout(() => {
                repliedElement.style.backgroundColor = '';
              }, 2000);
            }
          });
        }
        
        contentDiv.appendChild(replyPreview);
      }
      
      // Message content based on type
      if (message.type === 'text') {
        const textDiv = document.createElement('div');
        textDiv.className = 'message-text';
        textDiv.innerHTML = formatMessageText(message.content);
        contentDiv.appendChild(textDiv);
      } else if (message.type === 'image') {
        const img = document.createElement('img');
        img.className = 'message-image';
        img.src = message.content;
        img.alt = '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
        contentDiv.appendChild(img);
      } else if (message.type === 'sticker') {
        const stickerDiv = document.createElement('div');
        stickerDiv.className = 'message-sticker';
        stickerDiv.textContent = message.content;
        contentDiv.appendChild(stickerDiv);
      } else if (message.type === 'call') {
        const callDiv = document.createElement('div');
        callDiv.className = 'call-message';
        
        const callContent = document.createElement('div');
        callContent.className = 'call-message-content';
        
        const callIcon = document.createElement('div');
        callIcon.className = 'call-icon';
        callIcon.innerHTML = '<i class="fas fa-phone-alt"></i>';
        
        const callTitle = document.createElement('div');
        callTitle.className = 'call-title';
        callTitle.textContent = message.callMissed ? '–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫' : '–ó–≤–æ–Ω–æ–∫';
        
        const callDesc = document.createElement('div');
        callDesc.className = 'call-description';
        callDesc.textContent = `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${formatCallDuration(message.callDuration)}`;
        
        callContent.appendChild(callIcon);
        callContent.appendChild(callTitle);
        callContent.appendChild(callDesc);
        
        // Add call buttons if it's a recent call
        if (!message.callMissed && message.callEnded) {
          const callButtons = document.createElement('div');
          callButtons.className = 'call-buttons';
          
          const callBackBtn = document.createElement('button');
          callBackBtn.className = 'call-accept-btn';
          callBackBtn.innerHTML = '<i class="fas fa-phone-alt"></i> –ü–æ–∑–≤–æ–Ω–∏—Ç—å';
          callBackBtn.addEventListener('click', startCall);
          
          callButtons.appendChild(callBackBtn);
          callContent.appendChild(callButtons);
        }
        
        callDiv.appendChild(callContent);
        contentDiv.appendChild(callDiv);
      }
      
      // Reactions
      if (message.reactions && Object.keys(message.reactions).length > 0) {
        const reactionsDiv = document.createElement('div');
        reactionsDiv.className = 'reactions';
        
        // Show up to 4 reactions
        const reactionKeys = Object.keys(message.reactions).slice(0, 4);
        
        reactionKeys.forEach(reaction => {
          const reactionDiv = document.createElement('div');
          reactionDiv.className = 'reaction';
          
          // Check if current user reacted with this emoji
          if (message.reactions[reaction].includes(currentUser.id)) {
            reactionDiv.classList.add('user-reaction');
          }
          
          reactionDiv.textContent = reaction;
          
          const countSpan = document.createElement('span');
          countSpan.className = 'reaction-count';
          countSpan.textContent = message.reactions[reaction].length;
          
          reactionDiv.appendChild(countSpan);
          
          // Add users tooltip
          const usersTooltip = document.createElement('div');
          usersTooltip.className = 'reaction-users';
          
          const users = message.reactions[reaction].map(userId => {
            const user = chatUsers[userId];
            return user ? user.name : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
          }).join(', ');
          
          usersTooltip.textContent = users;
          reactionDiv.appendChild(usersTooltip);
          
          // Add click event to toggle reaction
          reactionDiv.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleReaction(message.id, reaction);
          });
          
          reactionsDiv.appendChild(reactionDiv);
        });
        
        contentDiv.appendChild(reactionsDiv);
      }
      
      // Message time and status
      const timeDiv = document.createElement('div');
      timeDiv.className = 'message-time';
      
      const timeSpan = document.createElement('span');
      timeSpan.textContent = formatTime(message.timestamp);
      timeDiv.appendChild(timeSpan);
      
      // Add status for own messages
      if (message.senderId === currentUser.id) {
        const statusDiv = document.createElement('div');
        statusDiv.className = 'message-status';
        
        const statusIcon = document.createElement('i');
        statusIcon.className = 'status-icon';
        
        if (message.readBy && message.readBy.length > 1) { // More than just sender
          statusIcon.classList.add('fas', 'fa-check-double', 'read');
        } else if (message.delivered) {
          statusIcon.classList.add('fas', 'fa-check-double');
        } else {
          statusIcon.classList.add('fas', 'fa-check');
        }
        
        statusDiv.appendChild(statusIcon);
        timeDiv.appendChild(statusDiv);
      }
      
      contentDiv.appendChild(timeDiv);
      
      // Add context menu event
      contentDiv.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        showMessageContextMenu(e, message);
      });
      
      // Add click event for mobile
      contentDiv.addEventListener('click', (e) => {
        if (window.innerWidth <= 768) {
          showMessageContextMenu(e, message);
        }
      });
      
      // Add pinned style if this is the pinned message
      if (currentChat.pinnedMessage === message.id) {
        contentDiv.classList.add('pinned-message');
      }
      
      messageDiv.appendChild(contentDiv);
      
      return messageDiv;
    }

    // Format message text (for links, etc.)
    function formatMessageText(text) {
      // Convert URLs to links
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.replace(urlRegex, '<a href="$1" target="_blank">$1</a>');
    }

    // Format time
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) { // Less than 1 minute
        return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
      } else if (diff < 3600000) { // Less than 1 hour
        return `${Math.floor(diff / 60000)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
      } else if (diff < 86400000) { // Less than 1 day
        return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      } else {
        return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
      }
    }

    // Format last seen
    function formatLastSeen(timestamp) {
      if (!timestamp) return '–¥–∞–≤–Ω–æ';
      
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) { // Less than 1 minute
        return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
      } else if (diff < 3600000) { // Less than 1 hour
        return `${Math.floor(diff / 60000)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
      } else if (diff < 86400000) { // Less than 1 day
        return `–±—ã–ª(–∞) –≤ ${date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}`;
      } else {
        return `–±—ã–ª(–∞) ${date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' })}`;
      }
    }

    // Format call duration
    function formatCallDuration(seconds) {
      if (!seconds) return '0:00';
      
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }

    // Handle message input
    function handleMessageInput() {
      const text = messageInput.value.trim();
      sendButton.disabled = text.length === 0;
      
      // Auto-resize textarea
      messageInput.style.height = 'auto';
      messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + 'px';
      
      // Send typing indicator
      sendTypingIndicator();
    }

    // Handle message keydown
    function handleMessageKeydown(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    }

    // Send message
    function sendMessage() {
      const text = messageInput.value.trim();
      
      if (text.length === 0) return;
      
      // Check for spam
      if (isSpam()) {
        showSpamWarning();
        return;
      }
      
      // Create message object
      const message = {
        id: generateId(),
        chatId: currentChat.id,
        senderId: currentUser.id,
        type: 'text',
        content: text,
        timestamp: Date.now(),
        delivered: false,
        readBy: [currentUser.id],
        replyTo: replyingTo
      };
      
      // Add to messages
      messages.push(message);
      
      // Save to localStorage (in a real app, this would save to Firebase)
      const allMessages = JSON.parse(localStorage.getItem('messages')) || {};
      allMessages[currentChat.id] = messages;
      localStorage.setItem('messages', JSON.stringify(allMessages));
      
      // Update UI
      renderMessages();
      scrollToBottomMessages();
      
      // Clear input
      messageInput.value = '';
      messageInput.style.height = 'auto';
      sendButton.disabled = true;
      
      // Cancel reply if any
      cancelReplyMessage();
      
      // Update last message time for spam detection
      lastMessageTime = Date.now();
      spamCount++;
      
      // Simulate message delivery and read
      setTimeout(() => {
        message.delivered = true;
        updateMessageInUI(message);
      }, 1000);
      
      setTimeout(() => {
        if (message.readBy.length === 1) { // Only sender
          message.readBy.push('user2'); // Simulate other user reading
          updateMessageInUI(message);
        }
      }, 3000);
    }

    // Check for spam
    function isSpam() {
      const now = Date.now();
      
      // Reset spam count after 10 seconds
      if (now - spamResetTime > 10000) {
        spamCount = 0;
        spamResetTime = now;
      }
      
      // Check if sending too many messages too quickly
      if (now - lastMessageTime < 1000 && spamCount >= 5) {
        return true;
      }
      
      // Check for duplicate messages
      const lastMessages = messages.slice(-5);
      const duplicateCount = lastMessages.filter(msg => 
        msg.senderId === currentUser.id && 
        msg.content === messageInput.value.trim()
      ).length;
      
      return duplicateCount >= 3;
    }

    // Show spam warning
    function showSpamWarning() {
      const warning = document.createElement('div');
      warning.className = 'spam-warning';
      warning.textContent = '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.';
      
      document.body.appendChild(warning);
      
      setTimeout(() => {
        warning.remove();
      }, 3000);
    }

    // Send typing indicator
    function sendTypingIndicator() {
      // In a real app, this would send to Firebase
      // For demo, we'll just show it locally
      if (typingTimeout) {
        clearTimeout(typingTimeout);
      }
      
      typingIndicator.style.display = 'flex';
      
      typingTimeout = setTimeout(() => {
        typingIndicator.style.display = 'none';
      }, 3000);
    }

    // Toggle reaction
    function toggleReaction(messageId, reaction) {
      const message = messages.find(m => m.id === messageId);
      if (!message) return;
      
      if (!message.reactions) {
        message.reactions = {};
      }
      
      if (!message.reactions[reaction]) {
        message.reactions[reaction] = [];
      }
      
      const userIndex = message.reactions[reaction].indexOf(currentUser.id);
      
      if (userIndex > -1) {
        // Remove reaction
        message.reactions[reaction].splice(userIndex, 1);
        
        // Remove reaction key if empty
        if (message.reactions[reaction].length === 0) {
          delete message.reactions[reaction];
        }
      } else {
        // Add reaction
        message.reactions[reaction].push(currentUser.id);
      }
      
      // Save to localStorage
      const allMessages = JSON.parse(localStorage.getItem('messages')) || {};
      allMessages[currentChat.id] = messages;
      localStorage.setItem('messages', JSON.stringify(allMessages));
      
      // Update UI
      updateMessageInUI(message);
    }

    // Update message in UI
    function updateMessageInUI(message) {
      const messageElement = document.querySelector(`.message[data-id="${message.id}"]`);
      if (messageElement) {
        const newMessageElement = createMessageElement(message);
        messageElement.parentNode.replaceChild(newMessageElement, messageElement);
      }
    }

    // Show message context menu
    function showMessageContextMenu(e, message) {
      e.preventDefault();
      e.stopPropagation();
      
      // Position the menu
      const x = e.clientX || e.touches[0].clientX;
      const y = e.clientY || e.touches[0].clientY;
      
      messageContextMenu.style.left = x + 'px';
      messageContextMenu.style.top = y + 'px';
      messageContextMenu.style.display = 'block';
      
      // Set context data
      messageContextMenu.dataset.messageId = message.id;
      
      // Update menu items based on message and user
      const isOwnMessage = message.senderId === currentUser.id;
      
      // Show/hide pin option based on permissions
      pinContextItem.style.display = 
        (currentChat.creator === currentUser.id || 
        (currentChat.admins && currentChat.admins.includes(currentUser.id))) ? 'flex' : 'none';
      
      // Show/hide delete option
      deleteContextItem.style.display = isOwnMessage ? 'flex' : 'none';
      
      // Update header
      const sender = chatUsers[message.senderId];
      contextHeader.textContent = sender ? sender.name : '–°–æ–æ–±—â–µ–Ω–∏–µ';
    }

    // Close context menu
    function closeContextMenu() {
      messageContextMenu.style.display = 'none';
    }

    // Reply to message
    function replyToMessage(messageId) {
      const message = messages.find(m => m.id === messageId);
      if (!message) return;
      
      replyingTo = messageId;
      
      // Update reply UI
      let previewText = '';
      
      if (message.type === 'text') {
        previewText = message.content;
      } else if (message.type === 'image') {
        previewText = 'üì∑ –§–æ—Ç–æ';
      } else if (message.type === 'sticker') {
        previewText = 'üé≠ –°—Ç–∏–∫–µ—Ä';
      } else if (message.type === 'call') {
        previewText = 'üìû –ó–≤–æ–Ω–æ–∫';
      }
      
      // Truncate if too long
      if (previewText.length > 50) {
        previewText = previewText.substring(0, 50) + '...';
      }
      
      replyContent.textContent = previewText;
      replyContainer.style.display = 'flex';
      
      // Focus on input
      messageInput.focus();
      
      // Close context menu
      closeContextMenu();
    }

    // Cancel reply
    function cancelReplyMessage() {
      replyingTo = null;
      replyContainer.style.display = 'none';
    }

    // Pin message
    function pinMessage(messageId) {
      if (!currentChat) return;
      
      // Check permissions
      if (currentChat.creator !== currentUser.id && 
          (!currentChat.admins || !currentChat.admins.includes(currentUser.id))) {
        showNotification('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –∑–∞–∫—Ä–µ–ø–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
        return;
      }
      
      currentChat.pinnedMessage = messageId;
      
      // Save to localStorage
      const chats = JSON.parse(localStorage.getItem('chats')) || {};
      chats[currentChat.id] = currentChat;
      localStorage.setItem('chats', JSON.stringify(chats));
      
      // Update UI
      updatePinnedMessage();
      renderMessages();
      
      showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ');
      closeContextMenu();
    }

    // Unpin message
    function unpinMessage() {
      if (!currentChat) return;
      
      currentChat.pinnedMessage = null;
      
      // Save to localStorage
      const chats = JSON.parse(localStorage.getItem('chats')) || {};
      chats[currentChat.id] = currentChat;
      localStorage.setItem('chats', JSON.stringify(chats));
      
      // Update UI
      updatePinnedMessage();
      renderMessages();
      
      showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–æ');
    }

    // Update pinned message display
    function updatePinnedMessage() {
      if (!currentChat || !currentChat.pinnedMessage) {
        pinnedMessageTop.style.display = 'none';
        return;
      }
      
      const pinnedMessage = messages.find(m => m.id === currentChat.pinnedMessage);
      if (!pinnedMessage) {
        pinnedMessageTop.style.display = 'none';
        return;
      }
      
      let content = '';
      
      if (pinnedMessage.type === 'text') {
        content = pinnedMessage.content;
      } else if (pinnedMessage.type === 'image') {
        content = 'üì∑ –§–æ—Ç–æ';
      } else if (pinnedMessage.type === 'sticker') {
        content = 'üé≠ –°—Ç–∏–∫–µ—Ä';
      } else if (pinnedMessage.type === 'call') {
        content = 'üìû –ó–≤–æ–Ω–æ–∫';
      }
      
      // Truncate if too long
      if (content.length > 100) {
        content = content.substring(0, 100) + '...';
      }
      
      pinnedMessageContent.textContent = content;
      
      const sender = chatUsers[pinnedMessage.senderId];
      pinnedMessageInfo.textContent = sender ? `–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ ${sender.name}` : '–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ';
      
      pinnedMessageTop.style.display = 'block';
    }

    // Delete message
    function deleteMessage(messageId) {
      const messageIndex = messages.findIndex(m => m.id === messageId);
      if (messageIndex === -1) return;
      
      // Remove from messages
      messages.splice(messageIndex, 1);
      
      // Save to localStorage
      const allMessages = JSON.parse(localStorage.getItem('messages')) || {};
      allMessages[currentChat.id] = messages;
      localStorage.setItem('messages', JSON.stringify(allMessages));
      
      // Update UI
      renderMessages();
      
      showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
      closeContextMenu();
    }

    // Start call
    function startCall() {
      if (!currentChat) return;
      
      // In a real app, this would create a call in Firebase and generate a link
      // For demo, we'll simulate it
      
      // Generate call ID and link
      const callId = generateId();
      const callLink = `${window.location.origin}/call.html?id=${callId}`;
      
      // Create call message
      const message = {
        id: generateId(),
        chatId: currentChat.id,
        senderId: currentUser.id,
        type: 'call',
        content: callLink,
        timestamp: Date.now(),
        callMissed: false,
        callEnded: false,
        callDuration: 0
      };
      
      // Add to messages
      messages.push(message);
      
      // Save to localStorage
      const allMessages = JSON.parse(localStorage.getItem('messages')) || {};
      allMessages[currentChat.id] = messages;
      localStorage.setItem('messages', JSON.stringify(allMessages));
      
      // Update UI
      renderMessages();
      scrollToBottomMessages();
      
      // Show call interface
      showOutgoingCall();
      
      // Also redirect to the call page
      window.open(callLink, '_blank');
      
      showNotification('–ó–≤–æ–Ω–æ–∫ –Ω–∞—á–∞—Ç');
    }

    // Show outgoing call interface
    function showOutgoingCall() {
      if (currentChat.type === 'private') {
        const otherUserId = currentChat.users.find(id => id !== currentUser.id);
        const otherUser = chatUsers[otherUserId];
        
        if (otherUser) {
          callName.textContent = otherUser.name;
          
          if (otherUser.avatar) {
            callAvatar.style.backgroundImage = `url(${otherUser.avatar})`;
            callAvatar.classList.add('has-image');
            callAvatar.textContent = '';
          } else {
            callAvatar.textContent = otherUser.name.charAt(0).toUpperCase();
            callAvatar.classList.remove('has-image');
          }
        }
      } else {
        callName.textContent = currentChat.name;
        
        if (currentChat.avatar) {
          callAvatar.style.backgroundImage = `url(${currentChat.avatar})`;
          callAvatar.classList.add('has-image');
          callAvatar.textContent = '';
        } else {
          callAvatar.textContent = currentChat.name.charAt(0).toUpperCase();
          callAvatar.classList.remove('has-image');
        }
      }
      
      callStatus.textContent = '–ó–≤–æ–Ω–æ–∫...';
      callTimer.textContent = '00:00';
      
      callContainer.style.display = 'flex';
      
      // Start call timer
      callStartTime = Date.now();
      callTimerInterval = setInterval(updateCallTimer, 1000);
    }

    // Update call timer
    function updateCallTimer() {
      if (!callStartTime) return;
      
      const now = Date.now();
      const diff = Math.floor((now - callStartTime) / 1000);
      
      const mins = Math.floor(diff / 60);
      const secs = diff % 60;
      
      callTimer.textContent = `${mins < 10 ? '0' : ''}${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }

    // End call
    function endCall() {
      // Stop timer
      if (callTimerInterval) {
        clearInterval(callTimerInterval);
        callTimerInterval = null;
      }
      
      // Hide call interface
      callContainer.style.display = 'none';
      incomingCall.style.display = 'none';
      
      // Update call message if exists
      const lastCallMessage = messages
        .filter(m => m.type === 'call')
        .pop();
      
      if (lastCallMessage && !lastCallMessage.callEnded) {
        lastCallMessage.callEnded = true;
        lastCallMessage.callDuration = Math.floor((Date.now() - lastCallMessage.timestamp) / 1000);
        
        // Save to localStorage
        const allMessages = JSON.parse(localStorage.getItem('messages')) || {};
        allMessages[currentChat.id] = messages;
        localStorage.setItem('messages', JSON.stringify(allMessages));
        
        // Update UI
        renderMessages();
      }
      
      showNotification('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
    }

    // Toggle mute call
    function toggleMuteCall() {
      callMuteBtn.classList.toggle('active');
      // In a real app, this would mute/unmute the audio
    }

    // Toggle video call
    function toggleVideoCall() {
      callVideoBtn.classList.toggle('active');
      // In a real app, this would enable/disable video
    }

    // Show incoming call
    function showIncomingCall() {
      if (currentChat.type === 'private') {
        const otherUserId = currentChat.users.find(id => id !== currentUser.id);
        const otherUser = chatUsers[otherUserId];
        
        if (otherUser) {
          incomingCallName.textContent = otherUser.name;
          
          if (otherUser.avatar) {
            incomingCallAvatar.style.backgroundImage = `url(${otherUser.avatar})`;
            incomingCallAvatar.classList.add('has-image');
            incomingCallAvatar.textContent = '';
          } else {
            incomingCallAvatar.textContent = otherUser.name.charAt(0).toUpperCase();
            incomingCallAvatar.classList.remove('has-image');
          }
        }
      }
      
      incomingCallType.textContent = '–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫';
      incomingCall.style.display = 'flex';
    }

    // Accept incoming call
    function acceptIncomingCall() {
      incomingCall.style.display = 'none';
      showOutgoingCall();
      callStatus.textContent = '–†–∞–∑–≥–æ–≤–æ—Ä';
    }

    // Decline incoming call
    function declineIncomingCall() {
      incomingCall.style.display = 'none';
      
      // Create missed call message
      const message = {
        id: generateId(),
        chatId: currentChat.id,
        senderId: currentUser.id,
        type: 'call',
        content: '',
        timestamp: Date.now(),
        callMissed: true,
        callEnded: true,
        callDuration: 0
      };
      
      // Add to messages
      messages.push(message);
      
      // Save to localStorage
      const allMessages = JSON.parse(localStorage.getItem('messages')) || {};
      allMessages[currentChat.id] = messages;
      localStorage.setItem('messages', JSON.stringify(allMessages));
      
      // Update UI
      renderMessages();
      scrollToBottomMessages();
      
      showNotification('–ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
    }

    // View user profile
    function viewUserProfile(userId) {
      const user = chatUsers[userId];
      if (!user) return;
      
      profileName.textContent = user.name;
      profileStatus.textContent = user.status === 'online' ? '–≤ —Å–µ—Ç–∏' : formatLastSeen(user.lastSeen);
      profilePhone.textContent = user.phone;
      profileEmail.textContent = user.email;
      profileRegDate.textContent = user.regDate;
      
      if (user.avatar) {
        profileAvatar.style.backgroundImage = `url(${user.avatar})`;
        profileAvatar.classList.add('has-image');
        profileAvatar.textContent = '';
      } else {
        profileAvatar.textContent = user.name.charAt(0).toUpperCase();
        profileAvatar.classList.remove('has-image');
      }
      
      // Load media (in a real app, this would fetch from messages)
      profileMediaGrid.innerHTML = '';
      const mediaMessages = messages.filter(m => 
        m.senderId === userId && (m.type === 'image' || m.type === 'sticker')
      ).slice(0, 9);
      
      mediaMessages.forEach(message => {
        const mediaItem = document.createElement('div');
        mediaItem.className = 'profile-media-item';
        
        if (message.type === 'image') {
          const img = document.createElement('img');
          img.src = message.content;
          img.alt = '–ú–µ–¥–∏–∞';
          mediaItem.appendChild(img);
        } else {
          mediaItem.className = 'profile-media-item profile-media-count';
          mediaItem.textContent = message.content;
        }
        
        profileMediaGrid.appendChild(mediaItem);
      });
      
      // If less than 9 items, fill with empty
      for (let i = mediaMessages.length; i < 9; i++) {
        const emptyItem = document.createElement('div');
        emptyItem.className = 'profile-media-item';
        profileMediaGrid.appendChild(emptyItem);
      }
      
      profileView.style.display = 'flex';
    }

    // View profile (current chat)
    function viewProfile() {
      if (currentChat.type === 'private') {
        const otherUserId = currentChat.users.find(id => id !== currentUser.id);
        viewUserProfile(otherUserId);
      } else {
        // For groups, we would show group profile
        // For now, just show a notification
        showNotification('–ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª—è –≥—Ä—É–ø–ø—ã');
      }
    }

    // Close profile view
    function closeProfileView() {
      profileView.style.display = 'none';
    }

    // Profile message action
    function profileMessageAction() {
      closeProfileView();
      messageInput.focus();
    }

    // Profile call action
    function profileCallAction() {
      closeProfileView();
      startCall();
    }

    // Join group
    function joinGroup() {
      if (!currentChat || currentChat.type !== 'group') return;
      
      // Add current user to group
      if (!currentChat.users.includes(currentUser.id)) {
        currentChat.users.push(currentUser.id);
        
        // Save to localStorage
        const chats = JSON.parse(localStorage.getItem('chats')) || {};
        chats[currentChat.id] = currentChat;
        localStorage.setItem('chats', JSON.stringify(chats));
      }
      
      // Update UI
      updateChatUI();
      
      showNotification('–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –≥—Ä—É–ø–ø–µ');
    }

    // Toggle chat menu
    function toggleChatMenu() {
      if (chatMenu.style.display === 'block') {
        chatMenu.style.display = 'none';
        overlay.style.display = 'none';
      } else {
        chatMenu.style.display = 'block';
        overlay.style.display = 'block';
      }
    }

    // Close all menus
    function closeAllMenus() {
      chatMenu.style.display = 'none';
      messageContextMenu.style.display = 'none';
      stickerPanel.style.display = 'none';
      overlay.style.display = 'none';
    }

    // Toggle sticker panel
    function toggleStickerPanel() {
      if (stickerPanel.style.display === 'flex') {
        stickerPanel.style.display = 'none';
      } else {
        stickerPanel.style.display = 'flex';
        overlay.style.display = 'block';
      }
    }

    // Load stickers
    function loadStickers() {
      // In a real app, this would fetch from Firebase or a sticker API
      // For demo, we'll use emoji as stickers
      const stickers = ['üòÄ', 'üòÇ', 'ü•∞', 'üòé', 'ü§î', 'üôÑ', 'üò¥', 'ü•≥', 'üò°', 'ü§Ø', 'ü•∂', 'ü§¢', 'üëª', 'üí©', 'üôè', 'üî•'];
      
      stickerPacks.innerHTML = '';
      
      stickers.forEach(sticker => {
        const pack = document.createElement('div');
        pack.className = 'sticker-pack';
        pack.textContent = sticker;
        pack.addEventListener('click', () => sendSticker(sticker));
        stickerPacks.appendChild(pack);
      });
    }

    // Send sticker
    function sendSticker(sticker) {
      // Create message object
      const message = {
        id: generateId(),
        chatId: currentChat.id,
        senderId: currentUser.id,
        type: 'sticker',
        content: sticker,
        timestamp: Date.now(),
        delivered: false,
        readBy: [currentUser.id]
      };
      
      // Add to messages
      messages.push(message);
      
      // Save to localStorage
      const allMessages = JSON.parse(localStorage.getItem('messages')) || {};
      allMessages[currentChat.id] = messages;
      localStorage.setItem('messages', JSON.stringify(allMessages));
      
      // Update UI
      renderMessages();
      scrollToBottomMessages();
      
      // Close sticker panel
      stickerPanel.style.display = 'none';
      overlay.style.display = 'none';
      
      // Simulate message delivery and read
      setTimeout(() => {
        message.delivered = true;
        updateMessageInUI(message);
      }, 1000);
      
      setTimeout(() => {
        if (message.readBy.length === 1) { // Only sender
          message.readBy.push('user2'); // Simulate other user reading
          updateMessageInUI(message);
        }
      }, 3000);
    }

    // Close sticker view
    function closeStickerViewPanel() {
      stickerView.style.display = 'none';
    }

    // Add new sticker pack
    function addNewStickerPack() {
      showNotification('–§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∏–∫–µ—Ä–ø–∞–∫–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
    }

    // Scroll to bottom of messages
    function scrollToBottomMessages() {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Handle scroll events
    function handleScroll() {
      // Show/hide scroll to bottom button
      const scrollThreshold = 100;
      const isNearBottom = messagesContainer.scrollHeight - messagesContainer.clientHeight - messagesContainer.scrollTop < scrollThreshold;
      
      if (isNearBottom) {
        scrollToBottom.classList.remove('visible');
      } else {
        scrollToBottom.classList.add('visible');
      }
    }

    // Adjust layout on resize
    function adjustLayout() {
      // Any layout adjustments needed on resize
    }

    // Go back
    function goBack() {
      window.history.back();
    }

    // Show notification
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      
      if (type === 'error') {
        notification.style.background = 'var(--danger-color)';
      } else if (type === 'success') {
        notification.style.background = 'var(--success-color)';
      }
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Generate ID
    function generateId() {
      return 'id_' + Math.random().toString(36).substr(2, 9);
    }

    // Set up real-time listeners (for demo, we'll simulate with intervals)
    function setupRealtimeListeners(chatId) {
      // Simulate incoming messages
      setInterval(() => {
        if (Math.random() < 0.02) { // 2% chance every interval
          simulateIncomingMessage();
        }
      }, 5000);
      
      // Simulate typing indicators
      setInterval(() => {
        if (Math.random() < 0.05) { // 5% chance every interval
          simulateTyping();
        }
      }, 10000);
      
      // Simulate incoming calls
      setInterval(() => {
        if (Math.random() < 0.01) { // 1% chance every interval
          simulateIncomingCall();
        }
      }, 30000);
    }

    // Simulate incoming message
    function simulateIncomingMessage() {
      if (!currentChat) return;
      
      const otherUserId = currentChat.users.find(id => id !== currentUser.id);
      if (!otherUserId) return;
      
      const messages = [
        '–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?',
        '–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?',
        '–¢—ã –≤–∏–¥–µ–ª –ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏?',
        '–ù–∞–ø–æ–º–Ω–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ –Ω–∞—à–µ–π –≤—Å—Ç—Ä–µ—á–µ',
        '–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!',
        '–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–º–æ—â—å!',
        '–ö–æ–≥–¥–∞ –æ—Å–≤–æ–±–æ–¥–∏—à—å—Å—è?',
        '–ü–æ—Å–º–æ—Ç—Ä–∏ —ç—Ç–æ –≤–∏–¥–µ–æ, –æ—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ!',
        '–£ —Ç–µ–±—è –µ—Å—Ç—å –ø–ª–∞–Ω—ã –Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã–µ?',
        '–Ø –∑–∞–∫–æ–Ω—á–∏–ª —Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç'
      ];
      
      const message = {
        id: generateId(),
        chatId: currentChat.id,
        senderId: otherUserId,
        type: 'text',
        content: messages[Math.floor(Math.random() * messages.length)],
        timestamp: Date.now(),
        delivered: true,
        readBy: [otherUserId]
      };
      
      // Add to messages
      this.messages.push(message);
      
      // Save to localStorage
      const allMessages = JSON.parse(localStorage.getItem('messages')) || {};
      allMessages[currentChat.id] = this.messages;
      localStorage.setItem('messages', JSON.stringify(allMessages));
      
      // Update UI
      renderMessages();
      
      // Show notification if not active
      if (!document.hasFocus()) {
        showNotification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ ${currentChat.name}`);
      }
    }

    // Simulate typing
    function simulateTyping() {
      if (!currentChat) return;
      
      const otherUserId = currentChat.users.find(id => id !== currentUser.id);
      if (!otherUserId) return;
      
      const otherUser = chatUsers[otherUserId];
      if (!otherUser) return;
      
      typingText.textContent = `${otherUser.name} –ø–µ—á–∞—Ç–∞–µ—Ç...`;
      typingIndicator.style.display = 'flex';
      
      setTimeout(() => {
        typingIndicator.style.display = 'none';
      }, 3000);
    }

    // Simulate incoming call
    function simulateIncomingCall() {
      if (!currentChat || currentChat.type !== 'private') return;
      
      showIncomingCall();
    }

    // Set up context menu actions
    replyContextItem.addEventListener('click', function() {
      const messageId = messageContextMenu.dataset.messageId;
      if (messageId) {
        replyToMessage(messageId);
      }
    });
    
    copyContextItem.addEventListener('click', function() {
      const messageId = messageContextMenu.dataset.messageId;
      const message = messages.find(m => m.id === messageId);
      
      if (message && message.type === 'text') {
        navigator.clipboard.writeText(message.content).then(() => {
          showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ');
          closeContextMenu();
        });
      }
    });
    
    pinContextItem.addEventListener('click', function() {
      const messageId = messageContextMenu.dataset.messageId;
      if (messageId) {
        pinMessage(messageId);
      }
    });
    
    forwardContextItem.addEventListener('click', function() {
      const messageId = messageContextMenu.dataset.messageId;
      showNotification('–§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
      closeContextMenu();
    });
    
    deleteContextItem.addEventListener('click', function() {
      const messageId = messageContextMenu.dataset.messageId;
      if (messageId) {
        deleteMessage(messageId);
      }
    });
    
    // Set up reaction buttons
    const reactionButtons = document.querySelectorAll('.reaction-btn');
    reactionButtons.forEach(button => {
      button.addEventListener('click', function() {
        const messageId = messageContextMenu.dataset.messageId;
        const reaction = this.textContent;
        
        if (messageId) {
          toggleReaction(messageId, reaction);
          closeContextMenu();
        }
      });
    });
  </script>
</body>
</html>
