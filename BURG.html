<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BURG</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        :root {
            --primary: #FF6B35;
            --primary-hover: #E55A2B;
            --text: #0F1419;
            --text-light: #5B7083;
            --border: #EBEEF0;
            --background: #FFFFFF;
            --hover: #F7F9F9;
            --card-shadow: rgba(0, 0, 0, 0.08) 0px 2px 12px;
            --error: #E0245E;
            --success: #17BF63;
        }

        [data-theme="dark"] {
            --primary: #FF6B35;
            --primary-hover: #FF8B5C;
            --text: #FFFFFF;
            --text-light: #8B98A5;
            --border: #2F3336;
            --background: #000000;
            --hover: #15181C;
            --card-shadow: rgba(255, 255, 255, 0.05) 0px 2px 12px;
            --error: #F4212E;
            --success: #00BA7C;
        }

        body {
            background: var(--background);
            color: var(--text);
            line-height: 1.4;
            transition: background 0.3s, color 0.3s;
        }

        .app {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
            position: relative;
        }

        /* Header */
        .header {
            position: sticky;
            top: 0;
            backdrop-filter: blur(10px);
            background: rgba(var(--background-rgb, 255, 255, 255), 0.9);
            border-bottom: 1px solid var(--border);
            padding: 16px;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        [data-theme="dark"] .header {
            background: rgba(0, 0, 0, 0.9);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 20px;
        }

        .logo i {
            color: var(--primary);
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .theme-toggle, .auth-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .theme-toggle:hover, .auth-btn:hover {
            background: var(--hover);
        }

        /* Auth Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--background);
            border-radius: 16px;
            max-width: 400px;
            width: 100%;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            margin-bottom: 25px;
        }

        .modal-header h2 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .modal-tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--border);
        }

        .tab-btn {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 10px 0;
            font-size: 16px;
            position: relative;
            transition: color 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            font-weight: 600;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            border-radius: 2px;
        }

        .auth-input {
            width: 100%;
            padding: 14px;
            margin-bottom: 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--background);
            color: var(--text);
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .auth-submit {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 10px;
        }

        .auth-submit:hover {
            background: var(--primary-hover);
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--hover);
            border: none;
            color: var(--text);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        /* Compose Tweet */
        .compose {
            padding: 20px 16px;
            border-bottom: 1px solid var(--border);
            position: relative;
        }

        .compose.disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        .compose-input {
            width: 100%;
            min-height: 60px;
            border: none;
            outline: none;
            resize: none;
            font-size: 20px;
            margin-bottom: 15px;
            background: transparent;
            color: var(--text);
        }

        .compose-input::placeholder {
            color: var(--text-light);
        }

        .image-preview {
            position: relative;
            margin: 12px 0;
            border-radius: 16px;
            overflow: hidden;
            display: none;
        }

        .image-preview.visible {
            display: block;
        }

        .image-preview img {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 16px;
        }

        .remove-image {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: transform 0.2s;
        }

        .remove-image:hover {
            transform: scale(1.1);
            background: rgba(0, 0, 0, 0.9);
        }

        .compose-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--primary);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background 0.2s;
            font-size: 18px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: rgba(255, 107, 53, 0.1);
        }

        .icon-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .post-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 15px;
        }

        .post-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .post-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Formatting Bar */
        .formatting-bar {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--hover);
            border-radius: 12px;
            flex-wrap: wrap;
            display: none;
        }

        .formatting-bar.visible {
            display: flex;
        }

        .format-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .format-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Feed */
        .feed {
            padding-bottom: 80px;
        }

        .tweet {
            padding: 18px 16px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
            cursor: pointer;
        }

        .tweet:hover {
            background: var(--hover);
        }

        .tweet-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #FF8B5C);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .user-info {
            flex: 1;
        }

        .user-info h3 {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 2px;
        }

        .time {
            color: var(--text-light);
            font-size: 14px;
        }

        .tweet-content {
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .tweet-content h1, .tweet-content h2, .tweet-content h3 {
            margin: 10px 0;
            font-weight: 700;
        }

        .tweet-content h1 { font-size: 1.4em; }
        .tweet-content h2 { font-size: 1.2em; }
        .tweet-content h3 { font-size: 1.1em; }

        .tweet-content strong {
            font-weight: 700;
        }

        .tweet-content em {
            font-style: italic;
        }

        .tweet-content u {
            text-decoration: underline;
        }

        .tweet-content code {
            background: var(--hover);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }

        .tweet-content a {
            color: var(--primary);
            text-decoration: none;
        }

        .tweet-content a:hover {
            text-decoration: underline;
        }

        .tweet-image {
            width: 100%;
            border-radius: 16px;
            margin-top: 12px;
            cursor: zoom-in;
            transition: opacity 0.2s;
        }

        .tweet-image:hover {
            opacity: 0.9;
        }

        .tweet-actions {
            display: flex;
            gap: 24px;
            margin-top: 15px;
            padding-left: 2px;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 14px;
            transition: color 0.2s;
            padding: 6px;
        }

        .action-btn:hover:not(:disabled) {
            color: var(--primary);
        }

        .action-btn.liked {
            color: #FF3856;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-light);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
            color: var(--primary);
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: var(--text);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text);
            color: var(--background);
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            z-index: 1001;
            animation: slideDown 0.3s ease, fadeOut 0.3s ease 2.7s;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        @keyframes slideDown {
            from {
                top: -100px;
                opacity: 0;
            }
            to {
                top: 20px;
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to { opacity: 0; }
        }

        /* User Info */
        .user-badge {
            background: var(--primary);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Welcome Message */
        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }

        .welcome-message h2 {
            color: var(--text);
            margin-bottom: 10px;
            font-size: 20px;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .app {
                border: none;
            }
            
            .header {
                padding: 12px 16px;
            }
            
            .compose {
                padding: 16px;
            }
            
            .modal-content {
                padding: 20px;
            }
        }

        /* File Input */
        #fileInput {
            display: none;
        }

        /* Text Formatting */
        .formatting-tag {
            background: rgba(255, 107, 53, 0.1);
            color: var(--primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-hamburger"></i>
                <span>BURG</span>
            </div>
            <div class="header-actions">
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="auth-btn" onclick="openAuthModal()" id="authBtn">
                    <i class="fas fa-user"></i>
                    <span>–í–æ–π—Ç–∏</span>
                </button>
            </div>
        </div>

        <!-- Compose Tweet -->
        <div class="compose" id="composeSection">
            <textarea 
                class="compose-input" 
                placeholder="–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?"
                id="tweetInput"
                onfocus="showFormattingBar()"
            ></textarea>
            
            <div class="formatting-bar" id="formattingBar">
                <button class="format-btn" onclick="formatText('bold')"><b>B</b></button>
                <button class="format-btn" onclick="formatText('italic')"><i>I</i></button>
                <button class="format-btn" onclick="formatText('underline')"><u>U</u></button>
                <button class="format-btn" onclick="formatText('code')">{ }</button>
                <button class="format-btn" onclick="formatText('link')">üîó</button>
                <button class="format-btn" onclick="formatText('h1')">H1</button>
                <button class="format-btn" onclick="formatText('h2')">H2</button>
                <button class="format-btn" onclick="formatText('h3')">H3</button>
            </div>
            
            <div class="image-preview" id="imagePreview">
                <img id="previewImage" src="" alt="">
                <button class="remove-image" onclick="removeImage()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="compose-actions">
                <div class="action-buttons">
                    <button class="icon-btn" onclick="openFilePicker()" title="–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ">
                        <i class="fas fa-image"></i>
                    </button>
                    <button class="icon-btn" onclick="toggleFormattingBar()" title="–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ">
                        <i class="fas fa-text-height"></i>
                    </button>
                </div>
                <input type="file" id="fileInput" accept="image/*" onchange="handleImageUpload(event)">
                <button class="post-btn" onclick="postTweet()" id="postBtn" disabled>
                    –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
                </button>
            </div>
        </div>

        <!-- Feed -->
        <div class="feed" id="feed">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeAuthModal()">
                <i class="fas fa-times"></i>
            </button>
            <div class="modal-header">
                <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ BURG</h2>
                <p style="color: var(--text-light);">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ —Å–æ–æ–±—â–µ—Å—Ç–≤—É</p>
            </div>
            
            <div class="modal-tabs">
                <button class="tab-btn active" onclick="switchTab('login')">–í—Ö–æ–¥</button>
                <button class="tab-btn" onclick="switchTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>
            
            <div id="loginForm">
                <input type="text" class="auth-input" id="loginEmail" placeholder="Email">
                <input type="password" class="auth-input" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
                <button class="auth-submit" onclick="login()">–í–æ–π—Ç–∏</button>
                <p style="text-align: center; margin-top: 15px; color: var(--text-light); font-size: 14px;">
                    –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" onclick="switchTab('register')" style="color: var(--primary);">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                </p>
            </div>
            
            <div id="registerForm" style="display: none;">
                <input type="text" class="auth-input" id="registerName" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                <input type="email" class="auth-input" id="registerEmail" placeholder="Email">
                <input type="password" class="auth-input" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å">
                <input type="password" class="auth-input" id="registerConfirmPassword" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                <button class="auth-submit" onclick="register()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                <p style="text-align: center; margin-top: 15px; color: var(--text-light); font-size: 14px;">
                    –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" onclick="switchTab('login')" style="color: var(--primary);">–í–æ–π—Ç–∏</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal" id="imageModal" onclick="closeImageModal()">
        <button class="close-modal" onclick="closeImageModal()">
            <i class="fas fa-times"></i>
        </button>
        <img id="modalImage" src="" alt="">
    </div>

    <script>
        // Configuration
        const FIREBASE_URL = "https://hamburger-messenger-default-rtdb.firebaseio.com/burg";
        const IMGBB_API_KEY = "02cf7a0dc37b8a8adaedc9784752a3db";
        
        // Current user (null if not logged in)
        let currentUser = null;
        let currentImage = null;
        let tweets = [];
        let isFormattingBarVisible = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            checkAuth();
            loadTweets();
            setupInputListeners();
            
            // Auto-refresh
            setInterval(loadTweets, 20000);
        });

        // Theme handling
        function loadTheme() {
            const savedTheme = localStorage.getItem('burg-theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('burg-theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.querySelector('.theme-toggle i');
            icon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            icon.title = theme === 'light' ? '–¢—ë–º–Ω–∞—è —Ç–µ–º–∞' : '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
        }

        // Authentication
        function checkAuth() {
            const savedUser = localStorage.getItem('burg-user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateAuthUI();
            }
        }

        function updateAuthUI() {
            const authBtn = document.getElementById('authBtn');
            const composeSection = document.getElementById('composeSection');
            
            if (currentUser) {
                authBtn.innerHTML = `<i class="fas fa-user-check"></i><span>${currentUser.name}</span>`;
                composeSection.classList.remove('disabled');
            } else {
                authBtn.innerHTML = `<i class="fas fa-user"></i><span>–í–æ–π—Ç–∏</span>`;
                composeSection.classList.add('disabled');
            }
        }

        function openAuthModal() {
            document.getElementById('authModal').style.display = 'flex';
        }

        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
        }

        function switchTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const tabs = document.querySelectorAll('.tab-btn');
            
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'login') {
                tabs[0].classList.add('active');
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                tabs[1].classList.add('active');
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            }
        }

        function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!email || !password) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            // Simple mock authentication
            currentUser = {
                id: 'user_' + email.replace(/[^a-z0-9]/gi, ''),
                name: email.split('@')[0],
                email: email,
                avatarColor: getRandomColor(),
                joined: Date.now()
            };
            
            localStorage.setItem('burg-user', JSON.stringify(currentUser));
            updateAuthUI();
            closeAuthModal();
            showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${currentUser.name}!`);
            loadTweets();
        }

        function register() {
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            if (!name || !email || !password) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showNotification('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
                return;
            }
            
            if (password.length < 6) {
                showNotification('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                return;
            }
            
            currentUser = {
                id: 'user_' + Date.now(),
                name: name,
                email: email,
                avatarColor: getRandomColor(),
                joined: Date.now()
            };
            
            localStorage.setItem('burg-user', JSON.stringify(currentUser));
            updateAuthUI();
            closeAuthModal();
            showNotification(`–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${name}!`);
            loadTweets();
        }

        function logout() {
            if (confirm('–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')) {
                currentUser = null;
                localStorage.removeItem('burg-user');
                updateAuthUI();
                showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞');
                loadTweets();
            }
        }

        // Tweet functionality
        function setupInputListeners() {
            const input = document.getElementById('tweetInput');
            const postBtn = document.getElementById('postBtn');
            
            input.addEventListener('input', function() {
                const hasText = this.value.trim().length > 0;
                const hasImage = currentImage !== null;
                postBtn.disabled = !currentUser || !(hasText || hasImage);
            });
            
            // Auto-resize
            input.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            });
        }

        function openFilePicker() {
            if (!currentUser) {
                showNotification('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ñ–æ—Ç–æ', 'error');
                return;
            }
            document.getElementById('fileInput').click();
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (–º–∞–∫—Å. 5MB)', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentImage = e.target.result;
                document.getElementById('previewImage').src = currentImage;
                document.getElementById('imagePreview').classList.add('visible');
                
                const text = document.getElementById('tweetInput').value.trim();
                document.getElementById('postBtn').disabled = !currentUser || (!text && !currentImage);
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            currentImage = null;
            document.getElementById('previewImage').src = '';
            document.getElementById('imagePreview').classList.remove('visible');
            document.getElementById('fileInput').value = '';
            
            const text = document.getElementById('tweetInput').value.trim();
            document.getElementById('postBtn').disabled = !currentUser || text.length === 0;
        }

        async function uploadImageToImgBB(base64Image) {
            try {
                const base64Data = base64Image.split(',')[1];
                const formData = new FormData();
                formData.append('image', base64Data);
                formData.append('key', IMGBB_API_KEY);
                
                const response = await fetch('https://api.imgbb.com/1/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                return data.data?.url || null;
            } catch (error) {
                console.error('Upload error:', error);
                return null;
            }
        }

        async function postTweet() {
            if (!currentUser) {
                showNotification('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å', 'error');
                return;
            }
            
            const text = document.getElementById('tweetInput').value.trim();
            
            if (!text && !currentImage) {
                showNotification('–î–æ–±–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ —Ñ–æ—Ç–æ', 'error');
                return;
            }
            
            const postBtn = document.getElementById('postBtn');
            postBtn.disabled = true;
            postBtn.textContent = '–ü—É–±–ª–∏–∫—É–µ–º...';
            
            let imageUrl = null;
            
            if (currentImage) {
                showNotification('–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ...');
                imageUrl = await uploadImageToImgBB(currentImage);
                
                if (!imageUrl) {
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ', 'error');
                    postBtn.disabled = false;
                    postBtn.textContent = '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å';
                    return;
                }
            }
            
            const tweet = {
                id: 'tweet_' + Date.now(),
                author: currentUser.name,
                authorId: currentUser.id,
                avatarColor: currentUser.avatarColor,
                text: text,
                imageUrl: imageUrl,
                likes: 0,
                timestamp: Date.now(),
                likedBy: []
            };
            
            try {
                const response = await fetch(`${FIREBASE_URL}/tweets/${tweet.id}.json`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(tweet)
                });
                
                if (response.ok) {
                    document.getElementById('tweetInput').value = '';
                    document.getElementById('tweetInput').style.height = '60px';
                    removeImage();
                    hideFormattingBar();
                    postBtn.textContent = '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!';
                    
                    showNotification('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ');
                    
                    setTimeout(() => {
                        postBtn.textContent = '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å';
                        loadTweets();
                    }, 1000);
                }
            } catch (error) {
                console.error('Post error:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏', 'error');
                postBtn.disabled = false;
                postBtn.textContent = '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å';
            }
        }

        async function loadTweets() {
            try {
                const response = await fetch(`${FIREBASE_URL}/tweets.json`);
                const data = await response.json();
                
                if (!data) {
                    tweets = [];
                    renderTweets([]);
                    return;
                }
                
                tweets = Object.values(data).sort((a, b) => b.timestamp - a.timestamp);
                renderTweets(tweets);
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        function renderTweets(tweetsToRender) {
            const feed = document.getElementById('feed');
            
            if (tweetsToRender.length === 0) {
                feed.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-feather"></i>
                        <h3>–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞</h3>
                        <p>–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –æ–ø—É–±–ª–∏–∫—É–µ—Ç —Ç–≤–∏—Ç!</p>
                    </div>
                `;
                return;
            }
            
            feed.innerHTML = tweetsToRender.map(tweet => {
                const isLiked = tweet.likedBy?.includes(currentUser?.id);
                const canInteract = currentUser !== null;
                
                return `
                    <div class="tweet" id="tweet-${tweet.id}">
                        <div class="tweet-header">
                            <div class="avatar" style="background: ${tweet.avatarColor || 'var(--primary)'}">
                                ${tweet.author?.charAt(0)?.toUpperCase() || 'A'}
                            </div>
                            <div class="user-info">
                                <h3>
                                    ${tweet.author || '–ê–Ω–æ–Ω–∏–º'}
                                    ${tweet.authorId === currentUser?.id ? '<span class="user-badge">–í—ã</span>' : ''}
                                </h3>
                                <div class="time">${formatTime(tweet.timestamp)}</div>
                            </div>
                        </div>
                        
                        ${tweet.text ? `
                            <div class="tweet-content">
                                ${formatTweetText(tweet.text)}
                            </div>
                        ` : ''}
                        
                        ${tweet.imageUrl ? `
                            <img class="tweet-image" 
                                 src="${tweet.imageUrl}" 
                                 alt="Tweet image"
                                 onclick="openImageModal('${tweet.imageUrl}')">
                        ` : ''}
                        
                        <div class="tweet-actions">
                            <button class="action-btn ${isLiked ? 'liked' : ''}" 
                                    onclick="${canInteract ? `toggleLike('${tweet.id}')` : 'openAuthModal()'}"
                                    ${!canInteract ? 'disabled' : ''}>
                                <i class="fas fa-heart"></i>
                                <span>${tweet.likes || 0}</span>
                            </button>
                            <button class="action-btn" onclick="shareTweet('${tweet.id}')">
                                <i class="fas fa-share"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function toggleLike(tweetId) {
            if (!currentUser) {
                showNotification('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫–∏', 'error');
                return;
            }
            
            const tweet = tweets.find(t => t.id === tweetId);
            if (!tweet) return;
            
            const isLiked = tweet.likedBy?.includes(currentUser.id);
            
            if (isLiked) {
                tweet.likes = (tweet.likes || 1) - 1;
                tweet.likedBy = tweet.likedBy?.filter(id => id !== currentUser.id) || [];
            } else {
                tweet.likes = (tweet.likes || 0) + 1;
                if (!tweet.likedBy) tweet.likedBy = [];
                tweet.likedBy.push(currentUser.id);
            }
            
            const likeBtn = document.querySelector(`#tweet-${tweetId} .action-btn`);
            const likeCount = document.querySelector(`#tweet-${tweetId} .action-btn span`);
            
            if (isLiked) {
                likeBtn.classList.remove('liked');
            } else {
                likeBtn.classList.add('liked');
            }
            likeCount.textContent = tweet.likes;
            
            try {
                await fetch(`${FIREBASE_URL}/tweets/${tweetId}.json`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        likes: tweet.likes,
                        likedBy: tweet.likedBy
                    })
                });
            } catch (error) {
                console.error('Like error:', error);
            }
        }

        function shareTweet(tweetId) {
            const tweet = tweets.find(t => t.id === tweetId);
            if (!tweet) return;
            
            const shareText = tweet.text ? tweet.text.substring(0, 100) : '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —ç—Ç–æ—Ç —Ç–≤–∏—Ç';
            const shareUrl = window.location.href;
            
            if (navigator.share) {
                navigator.share({
                    title: 'BURG',
                    text: shareText,
                    url: shareUrl
                });
            } else {
                navigator.clipboard.writeText(shareUrl);
                showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞');
            }
        }

        // Text formatting
        function showFormattingBar() {
            if (!isFormattingBarVisible) {
                document.getElementById('formattingBar').classList.add('visible');
            }
        }

        function hideFormattingBar() {
            document.getElementById('formattingBar').classList.remove('visible');
            isFormattingBarVisible = false;
        }

        function toggleFormattingBar() {
            isFormattingBarVisible = !isFormattingBarVisible;
            document.getElementById('formattingBar').classList.toggle('visible', isFormattingBarVisible);
        }

        function formatText(type) {
            const input = document.getElementById('tweetInput');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const selectedText = input.value.substring(start, end);
            
            let formattedText = '';
            
            switch(type) {
                case 'bold':
                    formattedText = `**${selectedText || '—Ç–µ–∫—Å—Ç'}**`;
                    break;
                case 'italic':
                    formattedText = `*${selectedText || '—Ç–µ–∫—Å—Ç'}*`;
                    break;
                case 'underline':
                    formattedText = `_${selectedText || '—Ç–µ–∫—Å—Ç'}_`;
                    break;
                case 'code':
                    formattedText = `\`${selectedText || '–∫–æ–¥'}\``;
                    break;
                case 'link':
                    formattedText = `[${selectedText || '—Ç–µ–∫—Å—Ç'}](https://)`;
                    break;
                case 'h1':
                    formattedText = `# ${selectedText || '–ó–∞–≥–æ–ª–æ–≤–æ–∫'}`;
                    break;
                case 'h2':
                    formattedText = `## ${selectedText || '–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫'}`;
                    break;
                case 'h3':
                    formattedText = `### ${selectedText || '–ó–∞–≥–æ–ª–æ–≤–æ–∫ 3'}`;
                    break;
            }
            
            input.value = input.value.substring(0, start) + formattedText + input.value.substring(end);
            
            const newCursorPos = start + formattedText.length;
            input.setSelectionRange(newCursorPos, newCursorPos);
            input.focus();
            
            input.dispatchEvent(new Event('input'));
        }

        function formatTweetText(text) {
            // Convert markdown-like formatting
            let formatted = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/_(.*?)_/g, '<u>$1</u>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/\n/g, '<br>');
            
            // Auto-detect URLs
            formatted = formatted.replace(
                /(https?:\/\/[^\s]+)/g,
                '<a href="$1" target="_blank">$1</a>'
            );
            
            return formatted;
        }

        // Image modal
        function openImageModal(imageUrl) {
            document.getElementById('modalImage').src = imageUrl;
            document.getElementById('imageModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('modalImage').src = '';
        }

        // Helper functions
        function getRandomColor() {
            const colors = ['#FF6B35', '#FF8B5C', '#FF9E6D', '#FFB07D', '#FFC38E'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function formatTime(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (seconds < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (minutes < 60) return `${minutes} –º–∏–Ω`;
            if (hours < 24) return `${hours} —á`;
            if (days === 1) return '–≤—á–µ—Ä–∞';
            if (days < 7) return `${days} –¥`;
            
            return new Date(timestamp).toLocaleDateString('ru', {
                month: 'short',
                day: 'numeric'
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            notification.style.background = type === 'error' ? 'var(--error)' : 'var(--text)';
            notification.style.color = type === 'error' ? 'white' : 'var(--background)';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                const postBtn = document.getElementById('postBtn');
                if (!postBtn.disabled) {
                    postTweet();
                }
            }
            
            if (e.key === 'Escape') {
                closeAuthModal();
                closeImageModal();
                hideFormattingBar();
            }
        });
    </script>
</body>
</html>
